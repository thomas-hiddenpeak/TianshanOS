
---
title: "Security Page Operation Guide (admin user)"
description: "Comprehensive instructions for the TianshanOS security page: SSH key management, remote host deployment, HTTPS certificate configuration, etc., aimed at admin users."
sidebarTitle: "Security Operation Guide"
icon: "shield-keyhole"
keywords:
  - SSH key management
  - public key deployment
  - known host fingerprints
  - HTTPS certificates
  - mTLS
  - admin user
  - operation guide
---

# Security Page Operation Guide

This document provides admin users with a complete walkthrough of the TianshanOS security page, covering everything from SSH key management and remote host access to HTTPS certificate configuration.

---

## Overview & Preparation

### Purpose of the Security Page

The **Security** page is TianshanOSâ€™s security hub. It centralizes the following capabilities:

1. **SSH Key Management**: Generate or import SSH keys directly on the device and keep them securely stored in the encrypted NVS partition.
2. **Remote Host Deployment**: Deploy public keys to remote Linux servers to enable passwordless login.
3. **Known Host Fingerprints**: Record SSH server fingerprints to prevent man-in-the-middle attacks.
4. **HTTPS Certificate Management**: Configure the deviceâ€™s mTLS certificates for mutual authentication.

### admin User Privileges

As an **admin user**, you can access **every feature** on the security page, including:

- âœ… Generate, delete, and export SSH keys
- âœ… Deploy public keys to remote servers
- âœ… Revoke deployed public keys
- âœ… Manage known host fingerprints
- âœ… Generate and manage HTTPS certificates

**Note**: The following pages require **root permissions** and are not accessible to admin users:
- âŒ Terminal page
- âŒ Automation page
- âŒ Command page

### How to Access the Security Page

1. Visit the deviceâ€™s WebUI in your browser (e.g., `http://192.168.4.1`)
2. Log in with the admin account (default password: `rm01`; **strongly recommended to change it on first login**)
3. Click the **â€œSecurityâ€** link in the top navigation bar
4. You will be taken to the Security page (URL route `#/security`)

### Page Layout Overview

The security page is divided into four blocks from top to bottom:

| Block | Description |
|------|-------------|
| **ğŸ”‘ Key Management** | Generate, view, export, deploy, revoke, and delete SSH keys |
| **ğŸ–¥ï¸ Deployed Hosts** | Manage the list of remote servers with deployed public keys; test connections, revoke keys, remove records |
| **ğŸ” Known Host Fingerprints** | View and delete SSH server fingerprints to block man-in-the-middle attacks |
| **ğŸ”’ HTTPS Certificates** | Generate device certificates/CSR, install CA-signed certificates, configure mTLS |

---

## Task 1: Generate and Use SSH Keys to Access Remote Servers

This task covers generating SSH keys from scratch, deploying the public key to a remote Linux server (such as a Jetson AGX Orin or a workstation), and achieving passwordless login.

### 2.1 Generate SSH Keys

#### Steps

1. **Enter the key management area**: Locate the â€œğŸ”‘ Key Managementâ€ block near the top of the security page.
2. **Click the generate button**: Press **â€œâ• Generate New Keyâ€**.
3. **Fill out the creation form** in the â€œğŸ”‘ Generate New Keyâ€ modal:

#### Form Field Details

| Field | Required | Description | Example |
|------|----------|-------------|---------|
| **Key ID** | âœ… Yes | A unique identifier for the key, used for future reference. Allowed characters: letters, digits, underscores. Must be unique. | `default`, `agx_key`, `lpmu_prod` |
| **Key Type** | âœ… Yes | Select the algorithm and key length. | See â€œKey Type Selectionâ€ below |
| **Notes** | âŒ No | Describe the keyâ€™s purpose for easier recognition later. | `For AGX Orin connection`, `Test environment key` |
| **Alias** | âŒ No | A friendly name displayed instead of the Key ID, useful when â€œhide keyâ€ is enabled. | `AGX Production`, `Main Server Key` |
| **Allow Private Key Export** | âŒ No | When checked, the private key can be exported for backup/migration. **Security risk**: leaked private keys allow unauthorized access. | Check only when backup is needed |
| **Hide Key ID** | âŒ No | When enabled, low-privilege users only see the alias or masked string instead of the real Key IDâ€”useful in multi-user environments. | Enable for shared devices |

#### Key Type Selection

| Type | Key Length | Generation Time | Compatibility | Recommended Use |
|------|------------|-----------------|---------------|------------------|
| **RSA 2048-bit** | 2048 bits | 5-10 seconds | â­â­â­â­â­ | **Recommended** for daily use due to wide compatibility |
| **RSA 4096-bit** | 4096 bits | 30-60 seconds | â­â­â­â­â­ | High-security scenarios; generation is slower |
| **ECDSA P-256** | 256 bits | 3-5 seconds | â­â­â­ | âš ï¸ **SSH public key auth not supported yet** |
| **ECDSA P-384** | 384 bits | 3-5 seconds | â­â­â­ | âš ï¸ **SSH public key auth not supported yet** |

**Important**: ECDSA keys cannot currently be used for SSH public key authentication. Please choose **RSA 2048-bit** or **RSA 4096-bit**.

#### Generation Flow

4. **Submit the form** by clicking **â€œGenerateâ€**.
5. **Wait for the process to finish**:
   - RSA 2048: ~5-10 seconds
   - RSA 4096: ~30-60 seconds (do not close the page)
   - The modal displays the progress.
6. **Confirm success**:
   - The modal shows â€œKey generated successfully.â€
   - Close the modal; the new key appears in the Key Management table.
7. **View key details**: The table lists the ID, type, notes, creation time, and exportability.

#### Notes

- **Unique Key ID**: If the ID already exists, an error will prompt you to choose another.
- **Do not interrupt**: Avoid refreshing the page or closing the browser during generation.
- **Persistent storage**: Keys are stored securely in the deviceâ€™s NVS (non-volatile storage) and survive reboots.
- **Storage limits**: NVS can store roughly 8 RSA-4096 keys or 32 ECDSA keys.

---

### 2.2 Deploy the Public Key to a Remote Server

After generating a key, deploy its **public portion** to a remote Linux server so passwordless login works.

#### Prerequisites

- âœ… At least one key exists in the Key Management table.
- âœ… You know the remote serverâ€™s IP address or hostname.
- âœ… You know the remote username and password (required for first deployment).
- âœ… Network connectivity exists between the device and the target server.

#### Steps

1. **Choose a key**: Pick the key row you want to deploy within the Key Management table.
2. **Click Deploy**: Press the **â€œğŸš€ Deployâ€** button (blue) on the right side of the row.
3. **Fill the deployment form** in the â€œğŸš€ Deploy Public Key to Remote Serverâ€ modal:

#### Deployment Form Fields

| Field | Required | Description | Example |
|------|----------|-------------|---------|
| **Target Host** | âœ… Yes | IP or hostname of the remote server. | `192.168.55.100`, `agx.local`, `10.10.99.98` |
| **Username** | âœ… Yes | Remote login user. | `root`, `nvidia`, `ubuntu` |
| **Port** | âŒ No | SSH port; default is 22. Change if using non-standard ports. | `22`, `2222`, `22022` |
| **Authentication Password** | âœ… Yes | Password for the first deployment. Future logins will skip the password. | Your serverâ€™s login password |

4. **Start the deployment** by clicking **â€œğŸš€ Start Deployâ€**.
5. **Watch the progress**: The modal shows logs including:
   - Connecting to the server
   - Verifying the host fingerprint (first-time connections prompt trust; see Task Three)
   - Uploading the public key to `~/.ssh/authorized_keys`
   - Validating deployment success
6. **Confirm success**:
   - â€œâœ… Public key deployment succeededâ€
   - â€œâœ… Connection verification succeededâ€
   - The host is automatically added to the â€œğŸ–¥ï¸ Deployed Hostsâ€ list.

#### Deployment Mechanism

The deployment performs these steps:
1. SSH into the server with the provided password.
2. Read the keyâ€™s public portion in OpenSSH format.
3. Append the public key to `~/.ssh/authorized_keys` on the server.
4. Test the key-based connection to ensure it works.

**Technical note**: This mirrors Linuxâ€™s `ssh-copy-id` behavior.

#### Troubleshooting

| Error | Possible Cause | Fix |
|-------|----------------|-----|
| **Connection Timeout** | Network unreachable, firewall blocking, SSH service down | Check connectivity (`ping`), verify SSH service (`systemctl status sshd`), adjust firewall rules |
| **Wrong Password** | Mistyped password or username | Double-check credentials, observe case sensitivity |
| **Permission Denied** | SSH server disallows password logins | Enable `PasswordAuthentication yes` in `/etc/ssh/sshd_config` |
| **Host Fingerprint Verification Failed** | First connection requires trusting the host | See Task Three: Manage Known Host Fingerprints |
| **authorized_keys Permission Issues** | Remote `.ssh` or `authorized_keys` has bad permissions | Ensure `~/.ssh` is 700 and `authorized_keys` is 600 |

---

## Task Two: Manage Deployed Hosts

The Deployed Hosts block tracks remote servers where the deviceâ€™s public keys are installed, making it easy to test and manage access.

### 3.1 View the Deployed Hosts List

#### Column Definitions

| Field | Meaning | Example |
|-------|---------|---------|
| **Host ID** | Auto-generated unique ID, format `KeyID@Host` | `agx_key@192.168.55.100`, `default@agx.local` |
| **Address** | Server IP or hostname | `192.168.55.100`, `10.10.99.98` |
| **Port** | SSH port | `22`, `2222` |
| **Username** | Remote login user | `nvidia`, `root`, `ubuntu` |
| **Deployed Key** | Key ID used (displayed as a badge) | ğŸ”‘ `agx_key`, ğŸ”‘ `default` |

#### When the List Updates

- âœ… Automatically adds hosts after successful WebUI deployment.
- âœ… Removes hosts after WebUI revocation.
- âœ… Deletes records when you click â€œRemove.â€
- âŒ Hosts added via CLI or manual `authorized_keys` edits do not appear.

#### Empty List Behavior

If the list shows â€œNo deployed hostsâ€:

- You havenâ€™t deployed any keys via the WebUI yet.
- Follow the Task 1, Section 2.2 steps to deploy a key.
- After a successful deployment, the host will automatically appear.

---
---
### 2.3 Use the Key for Passwordless Login

After deployment, you can connect to the remote server without entering a password.

#### Test the Connection via WebUI

1. **Go to the Deployed Hosts section** and find the host you just added.
2. **Click â€œğŸ” Testâ€** on that host row.
3. **Wait for the test**: the system will
   - Use the deployed key to connect
   - Execute a simple command (e.g., `whoami`) to validate
   - Review the output
4. **Check results**:
   - âœ… Success: displays â€œConnection successfulâ€ and the remote username
   - âŒ Failure: shows an error message (network issues, key mismatch, server configuration, etc.)

#### Use the Key from the Terminal

If you have root-level access to the terminal page or another CLI interface (e.g., serial), run:

```bash
# Start an interactive shell
ssh --host 192.168.1.100 --user nvidia --keyid agx_key --shell

# Execute a single command
ssh --host 192.168.1.100 --user nvidia --keyid agx_key --exec "nvidia-smi"

# Test the connection only
ssh --test --host 192.168.1.100 --user nvidia --keyid agx_key
```

**Parameter Guide**:
- `--host`: remote server address
- `--user`: login username
- `--keyid`: the Key ID stored in secure storage (same as used during deployment)
- `--shell`: launch an interactive shell session
- `--exec`: run a command and exit

#### Connection Failure Troubleshooting

If passwordless login still fails:

1. **Verify the correct key was deployed**:
   - Confirm the host exists in the Deployed Hosts list
   - Ensure the Key ID matches the one deployed
2. **Check network connectivity**:
   - Verify the device and server can reach each other (try `ping`)
3. **Check server settings**:
   - Ensure SSH service is running
   - Confirm `PubkeyAuthentication yes` in `/etc/ssh/sshd_config`
   - Verify `~/.ssh/authorized_keys` contains your public key
4. **Enable verbose logging**: add `--verbose` when running the SSH command to get detailed logs.

---

### 2.4 Revoke a Deployed Public Key

Revoke a key when you no longer need server access or suspect the key has been compromised.

#### When to Revoke

- ğŸš« Access is no longer required
- ğŸ”’ Suspected key compromise
- ğŸ”„ Server user changes necessitate key cleanup
- ğŸ§¹ Routine security audits call for removing stale access

#### Method One: Revoke from Key Management

**Ideal for when you know which key and server need revocation**

1. **Pick the key** from the Key Management table.
2. **Click â€œâš ï¸ Revokeâ€** (orange button).
3. **Fill out the revocation form**:

| Field | Required | Description |
|-------|----------|-------------|
| **Target Host** | âœ… Yes | Server address to remove the key from |
| **Username** | âœ… Yes | Login user on that server |
| **Port** | âŒ No | SSH port (default 22) |
| **Authentication Password** | âœ… Yes | Required because the key might no longer work |

4. **Confirm revocation** by clicking **â€œâš ï¸ Revoke Public Keyâ€**.
5. **Review results**:
   - âœ… Shows the number of key lines removed from `authorized_keys`
   - âœ… Deletes the host record from the Deployed Hosts list

#### Method Two: Revoke from Deployed Hosts

**Best for quick revocation of a specific host**

1. Go to the â€œğŸ–¥ï¸ Deployed Hostsâ€ table.
2. Click **â€œğŸ”“ Revokeâ€** (red button) on the target host row.
3. Enter the server password when prompted.
4. Confirm by clicking **â€œRevoke and Removeâ€**.
5. Wait as the system:
   - Connects to the server
   - Removes the matching public key from `authorized_keys`
   - Deletes the local host record

#### Remove Local Record Without Reaching the Server

Use this when the server is offline, the key already deleted on the server, or you simply want a cleaner UI.

1. Find the host in the Deployed Hosts table.
2. Click **â€œğŸ—‘ï¸ Removeâ€** (gray button).
3. Confirm removal.
4. The host record is deleted locally; the remote `authorized_keys` is untouched.

#### Revoke vs Remove

| Action | Remote Public Key | Local Record | Password Required | Usage |
|--------|-------------------|--------------|------------------|-------|
| **Revoke** | âœ… Deleted | âœ… Deleted | âœ… Required | Fully remove access |
| **Remove** | âŒ Retained | âœ… Deleted | âŒ Not required | Clean local record only |

---

### 2.5 Export Keys (Backup or Migration)

#### Export the Public Key

**Use Cases**:
- Adding the key manually to another serverâ€™s `authorized_keys`
- Sharing with teammates or devices
- Backing up the public key content

**Steps**:
1. Locate the key in the Key Management table.
2. Click **â€œğŸ“¤ Public Keyâ€**.
3. In the modal:
   - View the OpenSSH-formatted public key (`ssh-rsa AAAAB3NzaC1yc2E...`)
   - Click **â€œğŸ“‹ Copy to Clipboardâ€**
   - Or **â€œğŸ’¾ Download Fileâ€** to save as `.pub`
4. **Use the key** by pasting into `~/.ssh/authorized_keys` on another server or sharing it securely.

#### Export the Private Key

**Security Warning**: Private keys are extremely sensitive. Only export when necessary:
- ğŸ”’ Backups stored on encrypted offline media
- ğŸ”„ Migration to another device
- ğŸ› ï¸ Use in other SSH clients (desktop machines)

**Prerequisites**:
- The key must have been generated with **â€œAllow Private Key Exportâ€** enabled.
- Without that flag, the **â€œğŸ” Private Keyâ€** button is disabled.

**Steps**:
1. Select an exportable key.
2. Click **â€œğŸ” Private Keyâ€**.
3. Read the warning about exposure risks.
4. Confirm to continue.
5. In the export modal:
   - View the PEM-formatted private key (`-----BEGIN RSA PRIVATE KEY----- ...`)
   - Copy to clipboard or download as `.pem`

#### Private Key Handling Recommendations

1. **Secure Transfer**:
   - âŒ Do not send private keys via email
   - âŒ Avoid pasting them into chat apps
   - âŒ Donâ€™t upload them to unencrypted cloud storage
   - âœ… Use encrypted USB drives or encrypted archives
2. **Secure Storage**:
   - Store on encrypted disks or safes
   - Restrict permissions to 600
   - Keep them in password managers (1Password, Bitwarden, etc.)
3. **Post-use Cleanup**:
   - Delete temporary files immediately
   - Clear clipboard history
   - Do not use private keys on public computers
4. **Regular Review**:
   - Monitor for unauthorized use
   - Revoke and regenerate if exposure is suspected
## Task Three: Manage Known Host Fingerprints (Preventing MITM)

The Known Host Fingerprints block stores SSH server keys to guard against connecting to forged servers.

### 4.1 What Are Known Host Fingerprints

#### TOFU (Trust On First Use) Mechanism

**How it works**:
1. When you first connect to an SSH server, it sends its host key (public key).
2. The client computes the **SHA256 hash** (the fingerprint).
3. The system asks whether to trust the fingerprint.
4. Confirming saves the fingerprint to NVS.
5. Subsequent connections compare the serverâ€™s fingerprint with the stored value.
6. If they match, the connection proceeds silently; if not, a **security warning** appears.

#### Why Fingerprints Matter

- ğŸ›¡ï¸ **Prevent MITM attacks**: Verify youâ€™re talking to the legitimate server.
- ğŸ”’ **Server authentication**: Ensure the key hasnâ€™t been tampered with.
- ğŸ“‹ **Connection record**: Keep track of which servers youâ€™ve connected to.

#### Fingerprint Format

Fingerprints are SHA256 hashes of the SSH serverâ€™s host key, e.g.:

```
SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01=
```

---
### 3.2 SSH Connection Testing

Quickly verify the connectivity of a deployed host.

#### Steps

1. Select the host from the Deployed Hosts table.
2. Click **â€œğŸ” Testâ€**.
3. Wait as the system:
   - Uses the deployed key to connect
   - Runs a simple command (e.g., `whoami`)
   - Validates the return data
4. Review the result shown in the modal or status area.

#### Result Interpretation

**Successful Example**:
```
âœ… SSH connection test succeeded
Host: 192.168.55.100:22
User: nvidia
Command: whoami
Output: nvidia
```

**Failure Example**:
```
âŒ SSH connection test failed
Error: Connection timeout
Suggestion: Check network connectivity and firewall settings
```

#### Common Failure Fixes

| Error Type | Action |
|------------|--------|
| **Connection Timeout** | Check network, ensure the server is online, verify firewall rules |
| **Key Authentication Failed** | Public key may have been removedâ€”redeploy or verify `authorized_keys` |
| **Host Fingerprint Mismatch** | Server may have been reinstalled; update the fingerprint (see Task Three, Section 4.4) |
| **Permission Denied** | Review SSH server configuration and key file permissions |

---

### 3.3 Revoke Public Keys

Please refer to Task One, Section 2.4: â€œRevoking from Deployed Hostsâ€ for guidance.

---

### 3.4 Remove a Host Record

#### Revoke vs Remove

| Action | Local Record | Remote Public Key | Use Case |
|--------|--------------|-------------------|----------|
| **Revoke** | âœ… Deleted | âœ… Deleted | Fully remove access |
| **Remove** | âœ… Deleted | âŒ Retained | The server is decommissioned or key already removed |

#### When to Remove

- Host is offline or destroyed
- The public key was manually deleted on the server
- You simply want to clean the local list
- Only local cleanup is required while remote access remains

#### Steps

1. Select the host.
2. Click **â€œğŸ—‘ï¸ Removeâ€** (gray button).
3. Confirm in the dialog.
4. The host disappears from the list.

**Note**: Removal does not reach out to the remote server. To delete the remote key, use the Revoke action.

---
### 2.6 Delete Unneeded Keys

#### Pre-deletion Checklist

Before deleting a key, ensure:

- [ ] It is not deployed to critical servers, or revocation has been completed.
- [ ] You have exported a private key backup if needed.
- [ ] You understand deletion is irreversible without backups.
- [ ] The Deployed Hosts list no longer references it.

#### Steps

1. Choose the key from the Key Management table.
2. Click **â€œğŸ—‘ï¸ Deleteâ€** (red button).
3. Confirm in the warning dialog noting the action is permanent.
4. Click **â€œConfirmâ€** to proceed.
5. Verify the key disappears from the list.

#### Consequences

- âœ… Key removed permanently from NVS, freeing storage.
- âš ï¸ Deployed host records remain and must be cleaned separately.
- âŒ The key can no longer authenticate with servers unless re-created and redeployed.
- âŒ Recovery is impossible without a prior private key backup.

#### Post-deletion Cleanup

1. **Clean up Deployed Hosts**:
   - Open the Deployed Hosts table.
   - Remove any hosts that used the deleted key.
   - Optionally revoke remote keys before deleting if the server is still available.
2. **Notify collaborators**:
   - Inform other admins that the key is deleted.
   - Update documentation and access inventories.

---

## Task Four: Manage HTTPS Certificates (mTLS Mutual Authentication)

The â€œHTTPS Certificatesâ€ block configures the deviceâ€™s mTLS credentials so that it can act as an HTTPS server and participate in mutual authentication with clients.

### 5.1 HTTPS Certificate Overview

#### What is mTLS

**Mutual TLS (mTLS)** enables two-way TLS authentication:
- **Traditional HTTPS**: only the client validates the server (one-way).
- **mTLS**: both the server and the client authenticate each other (two-way).

**Benefits**:
- ğŸ”’ Prevents unauthorized clients from accessing the device.
- ğŸ›¡ï¸ Protects against man-in-the-middle attacks.
- ğŸ¯ Enables certificate-based access control (no password needed).

#### Certificate Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Root CA   â”‚ Trust anchor (stored offline)
â”‚  20-year TTLâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ issues
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Intermediateâ”‚ Online signing CA (e.g., step-ca)
â”‚     CA      â”‚
â”‚  10-year TTLâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ issues
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device Cert â”‚ This deviceâ€™s identity
â”‚ (this device)â”‚ Stored in NVS
â”‚  1-year TTL â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Private Key Never Leaves the Device

**Security design**:
- âœ… Key pairs are generated locally and never exported.
- âœ… Only CSR (Certificate Signing Request) can be exported.
- âœ… CA signs the CSR without ever seeing the private key.
- âœ… Private keys stay in NVS even across firmware updates.

**SSH key comparison**:
- SSH private keys may be exported if â€œAllow Private Key Exportâ€ is enabled.
- HTTPS certificate private keys are **never exportable** (a stricter policy).

---
### 4.6 When the Known Hosts List Is Empty

#### Possible Reasons

If the Known Host Fingerprints section always shows â€œNo known hostsâ€:

1. **First-time use**: You havenâ€™t connected to any SSH servers yet.
2. **Initialization bug**: The known host module didnâ€™t initialize properly when the security service started.

#### Solutions

**Method 1: Trigger initialization**
- Perform any SSH connection (e.g., deploy a key).
- Trust the host when prompted.
- Refresh the pageâ€”the list should populate.

**Method 2: Check the initialization**
- If Method 1 fails, see the â€œTroubleshootingâ€ documentâ€™s section on â€œKnown host list initially empty.â€
- It may be necessary to verify the security service calls `ts_known_hosts_init()`.

---
### 4.5 Delete Host Fingerprints

#### When to Use

- ğŸ—‘ï¸ The server is permanently offline or destroyed.
- ğŸ”„ The server was rebuilt and the old fingerprint must be cleared.
- ğŸ”€ The IP was reassigned to another host.
- ğŸ§¹ Routine cleanup of unused entries.

#### Steps

1. Select the host in the â€œğŸ” Known Host Fingerprintsâ€ table.
2. Click **â€œğŸ—‘ï¸ Deleteâ€**.
3. Confirm in the dialog.
4. The host is removed from the list.

#### Aftermath

- âœ… The fingerprint is permanently removed from NVS.
- âš ï¸ You will be prompted to trust the server again on the next connection.
- âŒ If the server was rebuilt, deleting the fingerprint is required to remove recurring mismatch warnings.

#### Bulk Deletion

To clear all fingerprints (e.g., resetting a test environment), run:

```bash
hosts --clear --yes
```

**Warning**: This removes every known host fingerprintâ€”use with caution.

---
### 4.4 Host Fingerprint Mismatch Warning

#### When It Occurs

If a saved hostâ€™s fingerprint changes, TianshanOS shows a security warning before connecting.

**Possible Causes**:

| Cause | Risk Level | Description |
|-------|------------|-------------|
| **Man-in-the-middle attack (MITM)** | ğŸ”´ High | An attacker is spoofing the server. |
| **Server reinstallation** | ğŸŸ¡ Legitimate | The server was rebuilt, generating a new host key. |
| **Key rotation** | ğŸŸ¡ Legitimate | Admin regenerated the SSH host key. |
| **IP reallocation** | ğŸŸ¡ Legitimate | The IP now maps to a different server. |

#### Warning Modal

The red warning dialog shows:

```
âš ï¸ Security Warning: Host fingerprint mismatch!

The host key has changed! This could mean:
â€¢ Man-in-the-Middle Attack
â€¢ Server reinstallation or key regeneration
â€¢ IP address now points to a different server

Host: 192.168.1.100:22
Stored fingerprint: SHA256:OldFingerprint123...
Current fingerprint: SHA256:NewFingerprint456...

Recommendation: If you confirmed the server was rebuilt or the key was rotated, click â€œUpdate Host Keyâ€
to remove the old record and reconnect to trust the new fingerprint.
```

#### Proper Handling

**Step 1: Halt the connection**
- Donâ€™t click â€œUpdate Host Keyâ€ immediately. Verify first.

**Step 2: Confirm what changed**

Options to verify:

1. **Contact the server administrator**:
   - Ask if the system was reinstalled or host key regenerated.
   - Request the new official fingerprint.
2. **Check server logs (if accessible)**:
   - Inspect install timestamps: `ls -l /var/log/installer/`
   - Check SSH key timestamps: `ls -l /etc/ssh/ssh_host_*_key`
3. **Physical verification**:
   - Run `ssh-keygen -lf /etc/ssh/ssh_host_*_key.pub` directly on the server.
   - Compare to the â€œCurrent fingerprintâ€ shown in the warning.

**Step 3: Act based on your findings**

**Scenario A: Legitimate change**
1. Click **â€œğŸ”„ Update Host Keyâ€** in the warning.
2. The old fingerprint is removed.
3. Retry connecting.
4. Trust the new fingerprint following the first-time connection procedure (Section 4.3).

**Scenario B: Unknown or suspicious**
1. Click **â€œCancelâ€**.
2. Do not continue connecting.
3. Investigate further:
   - Check network security (avoid untrusted Wi-Fi).
   - Ask the network team about ARP spoofing or DNS tampering.
   - Test from another device or network to compare fingerprints.

#### Consequences of Mistakes

- âŒ Blindly trusting the new fingerprint may expose your password and data to attackers.
- âŒ Ignoring the warning habitually weakens the security posture.

**Security principle**: When in doubt, stop the connection and investigate rather than blindly trusting a new fingerprint.

---
### 4.3 First-Time Connection to a New Server

#### Connection Flow

When connecting to a new SSH server for the first time (during deployment or manual SSH), the system prompts you to trust it.

**Step 1: Initiate the connection**
- Start the deployment or SSH connection.

**Step 2: Trust prompt**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NEW HOST - First time connecting to this server           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Host: 192.168.1.100:22
Key Type: ecdsa-sha2-nistp256
Fingerprint: SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01=

This is the first time connecting to this host.
Trust this host and continue? (yes/no):
```

**Step 3: Your decision**

| Input | Result | When to Use |
|-------|--------|-------------|
| **yes** | Trust the server, save the fingerprint to NVS, continue the connection | When you have verified the server |
| **no** | Abort the connection and do not save the fingerprint | Entered the wrong IP or unsure about the server |

**Step 4: Once trusted**
- The fingerprint appears in the Known Host Fingerprints list.
- The current connection proceeds.
- Future connections auto-verify the fingerprint without additional prompts.

#### High-Security Fingerprint Verification

Before trusting in critical environments:

1. **Obtain the official fingerprint**:
   - Ask the serverâ€™s administrator for the SHA256 fingerprint.
   - Or log into the server and run `ssh-keygen -lf /etc/ssh/ssh_host_*_key.pub`.
2. **Compare fingerprints**:
   - Match every character, including the key type.
3. **Trust after confirmation**:
   - If they match, type `yes`.
   - If not, type `no` and investigate.

---
### 4.2 View Known Host Fingerprints

#### Column Guide

| Field | Description | Example |
|-------|-------------|---------|
| **Host** | SSH server address | `192.168.1.100`, `agx.local` |
| **Port** | SSH port | `22`, `2222` |
| **Key Type** | Algorithm used by the host key | `ssh-rsa`, `ssh-ed25519`, `ecdsa-sha2-nistp256` |
| **Fingerprint (SHA256)** | Hash of the host key | `SHA256:xYzAbC... (partial)` |
| **Added Time** | When the server was trusted | `2026-01-30 14:30:00` |

#### View the Full Fingerprint

If the fingerprint is truncated:

1. Click **â€œğŸ‘ï¸ Viewâ€** on the target row.
2. The modal shows the complete fingerprint and host metadata.
3. Optionally compare it with the serverâ€™s official fingerprint.

**Retrieve the server fingerprint** by running on the host:

```bash
# ECDSA
ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub

# ED25519
ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub

# RSA
ssh-keygen -lf /etc/ssh/ssh_host_rsa_key.pub
```

Example output:
```
256 SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01= root@server (ECDSA)
```

---
## Task Three: Manage Known Host Fingerprints (Preventing MITM)

The Known Host Fingerprints block stores SSH server keys to guard against connecting to forged servers.

### 4.1 What Are Known Host Fingerprints

#### TOFU (Trust On First Use) Mechanism

**How it works**:
1. When you first connect to an SSH server, it sends its host key (public key).
2. The client computes the **SHA256 hash** (the fingerprint).
3. The system asks whether to trust the fingerprint.
4. Confirming saves the fingerprint to NVS.
5. Subsequent connections compare the serverâ€™s fingerprint with the stored value.
6. If they match, the connection proceeds silently; if not, a **security warning** appears.

#### Why Fingerprints Matter

- ğŸ›¡ï¸ **Prevent MITM attacks**: Verify youâ€™re talking to the legitimate server.
- ğŸ”’ **Server authentication**: Ensure the key hasnâ€™t been tampered with.
- ğŸ“‹ **Connection record**: Keep track of which servers youâ€™ve connected to.

#### Fingerprint Format

Fingerprints are SHA256 hashes of the SSH serverâ€™s host key, e.g.:

```
SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01=
```

---
### 3.2 SSH Connection Testing

Quickly verify the connectivity of a deployed host.

#### Steps

1. Select the host from the Deployed Hosts table.
2. Click **â€œğŸ” Testâ€**.
3. Wait as the system:
   - Uses the deployed key to connect
   - Runs a simple command (e.g., `whoami`)
   - Validates the return data
4. Review the result shown in the modal or status area.

#### Result Interpretation

**Successful Example**:
```
âœ… SSH connection test succeeded
Host: 192.168.55.100:22
User: nvidia
Command: whoami
Output: nvidia
```

**Failure Example**:
```
âŒ SSH connection test failed
Error: Connection timeout
Suggestion: Check network connectivity and firewall settings
```

#### Common Failure Fixes

| Error Type | Action |
|------------|--------|
| **Connection Timeout** | Check network, ensure the server is online, verify firewall rules |
| **Key Authentication Failed** | Public key may have been removedâ€”redeploy or verify `authorized_keys` |
| **Host Fingerprint Mismatch** | Server may have been reinstalled; update the fingerprint (see Task Three, Section 4.4) |
| **Permission Denied** | Review SSH server configuration and key file permissions |

---

### 3.3 Revoke Public Keys

Please refer to Task One, Section 2.4: â€œRevoking from Deployed Hostsâ€ for guidance.

---

### 3.4 Remove a Host Record

#### Revoke vs Remove

| Action | Local Record | Remote Public Key | Use Case |
|--------|--------------|-------------------|----------|
| **Revoke** | âœ… Deleted | âœ… Deleted | Fully remove access |
| **Remove** | âœ… Deleted | âŒ Retained | The server is decommissioned or key already removed |

#### When to Remove

- Host is offline or destroyed
- The public key was manually deleted on the server
- You simply want to clean the local list
- Only local cleanup is required while remote access remains

#### Steps

1. Select the host.
2. Click **â€œğŸ—‘ï¸ Removeâ€** (gray button).
3. Confirm in the dialog.
4. The host disappears from the list.

**Note**: Removal does not reach out to the remote server. To delete the remote key, use the Revoke action.

---
### 2.6 Delete Unneeded Keys

#### Pre-deletion Checklist

Before deleting a key, ensure:

- [ ] It is not deployed to critical servers, or revocation has been completed.
- [ ] You have exported a private key backup if needed.
- [ ] You understand deletion is irreversible without backups.
- [ ] The Deployed Hosts list no longer references it.

#### Steps

1. Choose the key from the Key Management table.
2. Click **â€œğŸ—‘ï¸ Deleteâ€** (red button).
3. Confirm in the warning dialog noting the action is permanent.
4. Click **â€œConfirmâ€** to proceed.
5. Verify the key disappears from the list.

#### Consequences

- âœ… Key removed permanently from NVS, freeing storage.
- âš ï¸ Deployed host records remain and must be cleaned separately.
- âŒ The key can no longer authenticate with servers unless re-created and redeployed.
- âŒ Recovery is impossible without a prior private key backup.

#### Post-deletion Cleanup

1. **Clean up Deployed Hosts**:
   - Open the Deployed Hosts table.
   - Remove any hosts that used the deleted key.
   - Optionally revoke remote keys before deleting if the server is still available.
2. **Notify collaborators**:
   - Inform other admins that the key is deleted.
   - Update documentation and access inventories.

---

## Task Four: Manage HTTPS Certificates (mTLS Mutual Authentication)

The â€œHTTPS Certificatesâ€ block configures the deviceâ€™s mTLS credentials so that it can act as an HTTPS server and participate in mutual authentication with clients.

### 5.1 HTTPS Certificate Overview

#### What is mTLS

**Mutual TLS (mTLS)** enables two-way TLS authentication:
- **Traditional HTTPS**: only the client validates the server (one-way).
- **mTLS**: both the server and the client authenticate each other (two-way).

**Benefits**:
- ğŸ”’ Prevents unauthorized clients from accessing the device.
- ğŸ›¡ï¸ Protects against man-in-the-middle attacks.
- ğŸ¯ Enables certificate-based access control (no password needed).

#### Certificate Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Root CA   â”‚ Trust anchor (stored offline)
â”‚  20-year TTLâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ issues
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Intermediateâ”‚ Online signing CA (e.g., step-ca)
â”‚     CA      â”‚
â”‚  10-year TTLâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ issues
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device Cert â”‚ This deviceâ€™s identity
â”‚ (this device)â”‚ Stored in NVS
â”‚  1-year TTL â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Private Key Never Leaves the Device

**Security design**:
- âœ… Key pairs are generated locally and never exported.
- âœ… Only CSR (Certificate Signing Request) can be exported.
- âœ… CA signs the CSR without ever seeing the private key.
- âœ… Private keys stay in NVS even across firmware updates.

**SSH key comparison**:
- SSH private keys may be exported if â€œAllow Private Key Exportâ€ is enabled.
- HTTPS certificate private keys are **never exportable** (a stricter policy).

---
### 4.6 When the Known Hosts List Is Empty

#### Possible Reasons

If the Known Host Fingerprints section always shows â€œNo known hostsâ€:

1. **First-time use**: You havenâ€™t connected to any SSH servers yet.
2. **Initialization bug**: The known host module didnâ€™t initialize properly when the security service started.

#### Solutions

**Method 1: Trigger initialization**
- Perform any SSH connection (e.g., deploy a key).
- Trust the host when prompted.
- Refresh the pageâ€”the list should populate.

**Method 2: Check the initialization**
- If Method 1 fails, see the â€œTroubleshootingâ€ documentâ€™s section on â€œKnown host list initially empty.â€
- It may be necessary to verify the security service calls `ts_known_hosts_init()`.

---
### 4.5 Delete Host Fingerprints

#### When to Use

- ğŸ—‘ï¸ The server is permanently offline or destroyed.
- ğŸ”„ The server was rebuilt and the old fingerprint must be cleared.
- ğŸ”€ The IP was reassigned to another host.
- ğŸ§¹ Routine cleanup of unused entries.

#### Steps

1. Select the host in the â€œğŸ” Known Host Fingerprintsâ€ table.
2. Click **â€œğŸ—‘ï¸ Deleteâ€**.
3. Confirm in the dialog.
4. The host is removed from the list.

#### Aftermath

- âœ… The fingerprint is permanently removed from NVS.
- âš ï¸ You will be prompted to trust the server again on the next connection.
- âŒ If the server was rebuilt, deleting the fingerprint is required to remove recurring mismatch warnings.

#### Bulk Deletion

To clear all fingerprints (e.g., resetting a test environment), run:

```bash
hosts --clear --yes
```

**Warning**: This removes every known host fingerprintâ€”use with caution.

---
### 4.4 Host Fingerprint Mismatch Warning

#### When It Occurs

If a saved hostâ€™s fingerprint changes, TianshanOS shows a security warning before connecting.

**Possible Causes**:

| Cause | Risk Level | Description |
|-------|------------|-------------|
| **Man-in-the-middle attack (MITM)** | ğŸ”´ High | An attacker is spoofing the server. |
| **Server reinstallation** | ğŸŸ¡ Legitimate | The server was rebuilt, generating a new host key. |
| **Key rotation** | ğŸŸ¡ Legitimate | Admin regenerated the SSH host key. |
| **IP reallocation** | ğŸŸ¡ Legitimate | The IP now maps to a different server. |

#### Warning Modal

The red warning dialog shows:

```
âš ï¸ Security Warning: Host fingerprint mismatch!

The host key has changed! This could mean:
â€¢ Man-in-the-Middle Attack
â€¢ Server reinstallation or key regeneration
â€¢ IP address now points to a different server

Host: 192.168.1.100:22
Stored fingerprint: SHA256:OldFingerprint123...
Current fingerprint: SHA256:NewFingerprint456...

Recommendation: If you confirmed the server was rebuilt or the key was rotated, click â€œUpdate Host Keyâ€
to remove the old record and reconnect to trust the new fingerprint.
```

#### Proper Handling

**Step 1: Halt the connection**
- Donâ€™t click â€œUpdate Host Keyâ€ immediately. Verify first.

**Step 2: Confirm what changed**

Options to verify:

1. **Contact the server administrator**:
   - Ask if the system was reinstalled or host key regenerated.
   - Request the new official fingerprint.
2. **Check server logs (if accessible)**:
   - Inspect install timestamps: `ls -l /var/log/installer/`
   - Check SSH key timestamps: `ls -l /etc/ssh/ssh_host_*_key`
3. **Physical verification**:
   - Run `ssh-keygen -lf /etc/ssh/ssh_host_*_key.pub` directly on the server.
   - Compare to the â€œCurrent fingerprintâ€ shown in the warning.

**Step 3: Act based on your findings**

**Scenario A: Legitimate change**
1. Click **â€œğŸ”„ Update Host Keyâ€** in the warning.
2. The old fingerprint is removed.
3. Retry connecting.
4. Trust the new fingerprint following the first-time connection procedure (Section 4.3).

**Scenario B: Unknown or suspicious**
1. Click **â€œCancelâ€**.
2. Do not continue connecting.
3. Investigate further:
   - Check network security (avoid untrusted Wi-Fi).
   - Ask the network team about ARP spoofing or DNS tampering.
   - Test from another device or network to compare fingerprints.

#### Consequences of Mistakes

- âŒ Blindly trusting the new fingerprint may expose your password and data to attackers.
- âŒ Ignoring the warning habitually weakens the security posture.

**Security principle**: When in doubt, stop the connection and investigate rather than blindly trusting a new fingerprint.

---
### 4.3 First-Time Connection to a New Server

#### Connection Flow

When connecting to a new SSH server for the first time (during deployment or manual SSH), the system prompts you to trust it.

**Step 1: Initiate the connection**
- Start the deployment or SSH connection.

**Step 2: Trust prompt**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NEW HOST - First time connecting to this server           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Host: 192.168.1.100:22
Key Type: ecdsa-sha2-nistp256
Fingerprint: SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01=

This is the first time connecting to this host.
Trust this host and continue? (yes/no):
```

**Step 3: Your decision**

| Input | Result | When to Use |
|-------|--------|-------------|
| **yes** | Trust the server, save the fingerprint to NVS, continue the connection | When you have verified the server |
| **no** | Abort the connection and do not save the fingerprint | Entered the wrong IP or unsure about the server |

**Step 4: Once trusted**
- The fingerprint appears in the Known Host Fingerprints list.
- The current connection proceeds.
- Future connections auto-verify the fingerprint without additional prompts.

#### High-Security Fingerprint Verification

Before trusting in critical environments:

1. **Obtain the official fingerprint**:
   - Ask the serverâ€™s administrator for the SHA256 fingerprint.
   - Or log into the server and run `ssh-keygen -lf /etc/ssh/ssh_host_*_key.pub`.
2. **Compare fingerprints**:
   - Match every character, including the key type.
3. **Trust after confirmation**:
   - If they match, type `yes`.
   - If not, type `no` and investigate.

---
### 4.2 View Known Host Fingerprints

#### Column Guide

| Field | Description | Example |
|-------|-------------|---------|
| **Host** | SSH server address | `192.168.1.100`, `agx.local` |
| **Port** | SSH port | `22`, `2222` |
| **Key Type** | Algorithm used by the host key | `ssh-rsa`, `ssh-ed25519`, `ecdsa-sha2-nistp256` |
| **Fingerprint (SHA256)** | Hash of the host key | `SHA256:xYzAbC... (partial)` |
| **Added Time** | When the server was trusted | `2026-01-30 14:30:00` |

#### View the Full Fingerprint

If the fingerprint is truncated:

1. Click **â€œğŸ‘ï¸ Viewâ€** on the target row.
2. The modal shows the complete fingerprint and host metadata.
3. Optionally compare it with the serverâ€™s official fingerprint.

**Retrieve the server fingerprint** by running on the host:

```bash
# ECDSA
ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub

# ED25519
ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub

# RSA
ssh-keygen -lf /etc/ssh/ssh_host_rsa_key.pub
```

Example output:
```
256 SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01= root@server (ECDSA)
```

---
## Secure Storage vs. File-Based Keys

This section explains why TianshanOS uses secure storage (NVS) over filesystem-based keys by default.

### Comparison Table

| Feature | Secure Storage (NVS) | File Keys (SD Card) |
|---------|----------------------|--------------------|
| **Private Key Protection** | âœ… Encrypted NVS partition; extraction is difficult | âš ï¸ Plaintext PEM files that can be copied or leaked |
| **Usability** | âœ… Only remember the Key ID; no file paths | âŒ Requires remembering file paths, which can be confusing |
| **Key Backup** | âš ï¸ Requires enabling â€œAllow Exportâ€ | âœ… Copy the file directly |
| **Cross-Device Use** | âŒ Bound to a single device | âœ… Copy to multiple devices |
| **Protection Against Accidental Deletion** | âœ… Must explicitly delete | âš ï¸ Filesystem issues can result in loss |
| **Storage Capacity** | âš ï¸ NVS has a limited capacity (8-32 keys) | âœ… SD cards have large capacity |
| **Access Speed** | âœ… Fast NVS access | âš ï¸ Slower SD card I/O |
| **Security Rating** | â­â­â­â­â­ (5 stars) | â­â­ (2 stars) |
| **Recommended Use** | ğŸ¯ Production, long-term, security-sensitive | Temporary use, key migration, multi-device sharing |

### Advantages of Secure Storage

1. **Hardware-backed protection**:
   - NVS partitions support flash encryption (recommended in production).
   - Private keys are hard to extract physically.
2. **Default security**:
   - Keys cannot be exported unless explicitly allowed.
   - Prevents accidental leaks.
3. **Centralized management**:
   - All keys are viewable/manageable through the WebUI.
   - Keys are not scattered across filesystems.
4. **Access control**:
   - â€œHide Key IDâ€ prevents low-privilege users from seeing sensitive identifiers.
   - â€œAllow exportâ€ flag enables fine-grained controls.

### When to Use File-Based Keys

Although secure storage is preferred, file keys may be appropriate when:

- ğŸ”„ **Migration**: Import an existing key from another device.
- ğŸ§ª **Temporary testing**: Use a key for a short-lived test.
- ğŸ”€ **Multi-device sharing**: The same key must run on several devices.
- ğŸ“¤ **External tooling**: Desktop SSH clients (PuTTY, Terminal) require file keys.

**CLI Example for File Keys**:
```bash
# Use a key stored on the SD card
ssh --host 192.168.1.100 --user nvidia --key /sdcard/id_rsa --shell
```

---
### 5.6 Certificate Renewal

#### When to Renew

- â° The certificate is expiring soon (start renewal 30 days before expiry).
- âš ï¸ The status card shows â€œExpiring soonâ€ or remaining days < 30.
- ğŸ“… Company PKI policy dictates issued certificates renew annually or by schedule.

#### Renewal Steps

**Option 1: Keep the same key pair (recommended)**

1. **Generate a fresh CSR**:
   - Click **â€œğŸ“‹ Generate CSRâ€** (you can reuse the same CN).
   - Copy the new CSR.
2. **Submit it to the CA**:
   - Send the CSR to your CA for renewal.
   - Receive a new certificate.
3. **Install the new certificate**:
   - Click **â€œğŸ“¥ Install Certificate.â€**
   - Paste the renewed certificate.
4. **Check the status**:
   - The expiration date should update to the new certificateâ€™s validity.
   - Days remaining should reflect the new lifetime.

**Option 2: Full refresh (if the private key may be compromised)**

1. Delete all credentials via **â€œğŸ—‘ï¸ Delete Credentials.â€**
2. Start again from Step 5.3.1 (generate a new key pair).
3. Go through the full 5.3 flow (CSR, CA signing, install certificate, install CA chain).

#### Renewal Notes

- âœ… The old certificate remains valid until its expiry.
- âœ… The new certificate takes effect immediately once installed.
- âœ… CA chains rarely need updates unless the CA infrastructure changes.
- âš ï¸ If the CA chain itself is expiring, renew it alongside the device certificate.

#### Automated Renewal (Future Feature)

Currently, renewal is manual. Future versions may:
- Detect expiring certificates automatically
- Generate CSRs and submit to ACME CAs
- Install refreshed certificates without manual intervention

---
### 5.5 Delete All PKI Credentials (Factory Reset)

**Warning**: This action wipes all HTTPS certificate data. Confirm before proceeding.

#### What Gets Deleted

Clicking **â€œğŸ—‘ï¸ Delete Credentialsâ€** removes:
- ğŸ”‘ The device private key (ECDSA P-256)
- ğŸ“„ The device certificate
- ğŸ›ï¸ The CA certificate chain

#### When to Use

| Scenario | Description |
|----------|-------------|
| **Device reconfiguration** | You need to change the device ID or PKI structure. |
| **CA changes** | Your organization replaced the CA or PKI workflow. |
| **Test reset** | Clear all test data and redo the certificate flow. |
| **Security incident** | Suspect a private key leak; start fresh. |

#### Steps

1. Click **â€œğŸ—‘ï¸ Delete Credentialsâ€** (red button).
2. Read the warning dialog:
   ```
   âš ï¸ Warning: This deletes all PKI credentials

   This action will remove:
   â€¢ Device private key
   â€¢ Device certificate
   â€¢ CA certificate chain

   After deletion:
   â€¢ mTLS will be unavailable
   â€¢ You must regenerate keys and reapply for certificates
   â€¢ This action cannot be undone

   Do you want to continue?
   ```
3. Confirm if you understand the impact.
4. After completion:
   - The status card reverts to â€œğŸ”’ Key pair not generated.â€
   - All buttons return to their initial states.
   - The HTTPS key row disappears from the Key Management table.

#### Impact

- **HTTPS service**:
  - May fall back to HTTP (if allowed).
  - Or use a temporary self-signed certificate, causing browser warnings.
  - mTLS stops working.
- **Clients**:
  - mTLS-aware clients cannot verify the device.
  - Browsers may show certificate errors.
- **Recovery**:
  - Start Section 5.3 from Step 5.3.1 again to rebuild the entire PKI.

---
### 5.4 View Installed Certificate

**Use Cases**:
- Inspect the full PEM content of the device certificate.
- Confirm certificate details (CN, validity, issuer).
- Copy the certificate for client configuration or backups.

**Steps**:
1. Ensure the device certificate is installed (the â€œğŸ‘ï¸ View Certificateâ€ button is enabled).
2. Click **â€œğŸ‘ï¸ View Certificate.â€**
3. Wait as â€œğŸ”„ Loading...â€ appears for 1-2 seconds.
4. The modal displays the entire PEM content (scrollable).
5. Optional: click **â€œğŸ“‹ Copy to Clipboardâ€** for reuse.
6. Close the modal when finished.

#### Certificate Inspection

To analyze the certificate on Linux/macOS:

```bash
# Save the certificate as device.crt, then run:
openssl x509 -in device.crt -text -noout
```

Sample output:
```
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 01:23:45:67:89:ab
        Signature Algorithm: ecdsa-with-SHA256
        Issuer: CN=TianShanOS Intermediate CA
        Validity
            Not Before: Jan 27 00:00:00 2026 GMT
            Not After : Jan 27 00:00:00 2027 GMT
        Subject: CN=TIANSHAN-RM01-0001, O=HiddenPeak Labs, OU=Device
        Subject Public Key Info:
            Public Key Algorithm: id-ecPublicKey
                Public-Key: (256 bit)
```

---
#### 5.3.5 Install the CA Certificate Chain

**Purpose**: Install the CA chain (root + intermediate) so clients can validate the device certificate.

**Prerequisites**:
- âœ… Device certificate installed (Section 5.3.4).
- âœ… CA chain file in PEM format.

**Why you need it**:
- Clients need a complete trust path: `Device Cert â† Intermediate CA â† Root CA`.
- Without it, browsers or clients will show â€œUnable to verify certificate.â€

**Steps**:
1. Prepare the CA chain file (e.g., `ca-chain.pem`) containing root and intermediate certificates.
2. Open the file and copy everything:
   ```
   -----BEGIN CERTIFICATE-----
   (Root CA content)
   -----END CERTIFICATE-----
   -----BEGIN CERTIFICATE-----
   (Intermediate CA content)
   -----END CERTIFICATE-----
   ```
3. Click **â€œğŸ›ï¸ Install CA.â€**
4. Paste the chain into the modalâ€™s text box (all `BEGIN/END` sections).
5. Click **â€œğŸ›ï¸ Install.â€**
6. Wait for validation and storage in NVS.
7. Confirmation steps:
   - â€œâœ… CA chain installed successfully.â€
   - Status card shows â€œâœ… Activatedâ€ (if the certificate is valid).
   - mTLS configuration is now complete.

#### CA Chain Examples

**Single-level CA**:
```
-----BEGIN CERTIFICATE-----
(Self-signed root CA)
-----END CERTIFICATE-----
```

**Two-level CA**:
```
-----BEGIN CERTIFICATE-----
(Root CA)
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
(Intermediate CA)
-----END CERTIFICATE-----
```

- Multiple certificate blocks are acceptable (root + intermediates).
- Order is not critical; the system auto-detects root vs. intermediates.
- For simple setups, a single root block suffices.

#### Post-installation Validation

1. Check the status card:
   - Should read â€œâœ… Activatedâ€
   - Validity shows â€œâœ… Validâ€
   - Days remaining should be accurate
2. Test an mTLS client (configured to trust the same CA):
   - Connect to the device using an mTLS-aware client.
   - Ensure dual authentication succeeds.

---
#### 5.3.4 Install the Device Certificate

**Goal**: Install the CA-signed device certificate so mTLS works.

**Prerequisites**:
- âœ… Key pair must exist.
- âœ… You have the signed certificate in PEM format.
- âœ… The certificate was signed from the CSR you generated.

**Steps**:
1. Open the certificate file (`device.crt`) on your computer.
2. Copy its entire PEM block:
   ```
   -----BEGIN CERTIFICATE-----
   MIICxzCCAa+gAwIBAgIRAMxBxOxxxxxxxxxxxxxxxxxxxxxxxx
   (Base64 lines)
   xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxQ=
   -----END CERTIFICATE-----
   ```
3. Click **â€œğŸ“¥ Install Certificate.â€**
4. Paste the certificate into the â€œCertificate PEMâ€ field, ensuring the `BEGIN/END` lines are present.
5. Click **â€œğŸ“¥ Install.â€**
6. Wait while the system validates:
   - âœ… Correct PEM format
   - âœ… Certificate matches the private key
   - âœ… Certificate is currently valid (within its validity window)
   - âœ… Subject fields look as expected
7. Confirm when the modal shows:
   - â€œâœ… Certificate installed successfullyâ€
   - Displayed certificate details (CN, issuer, validity)
   - Status card updates to â€œActivatedâ€ or â€œCertificate installed, CA chain missingâ€

#### Common Errors

| Error Message | Cause | Resolution |
|---------------|-------|------------|
| **Certificate and private key do not match** | CA signed a CSR from another device | Generate a new CSR and resubmit, or delete credentials and restart |
| **Invalid certificate format** | PEM headers missing or corrupted | Verify the copied content includes `-----BEGIN/END CERTIFICATE-----` |
| **Certificate expired** | You installed a past-dated certificate | Ask the CA for a new certificate |
| **Unable to parse certificate** | The file is corrupted | Download or copy the certificate again |

#### How Matching Works

The system:
1. Extracts the public key from the certificate.
2. Loads the private key from NVS.
3. Verifies they form a key pair.
4. Allows installation only when they match.

**Why it matters**: A mismatched certificate canâ€™t complete TLS handshakes and will break HTTPS.

---
#### 5.3.3 Submit to CA for Signing (External)

**Purpose**: Send the CSR to a Certificate Authority to receive the device certificate.

**Note**: This step happens outside the device. Use your CA server or contact your PKI administrator.

#### Common CA Options

##### Option 1: Internal CA (e.g., step-ca)

If your organization uses step-ca or an internal CA:

1. Access the CA server or use the `step` CLI.
2. Submit the CSR:
   ```bash
   # Save CSR as device.csr then run
   step ca certificate --csr device.csr device.crt

   # Or paste the CSR manually
   cat > device.csr << 'EOF'
   -----BEGIN CERTIFICATE REQUEST-----
   (paste CSR here)
   -----END CERTIFICATE REQUEST-----
   EOF

   step ca certificate --csr device.csr device.crt
   ```
3. Retrieve:
   - `device.crt`: the signed device certificate (needed in the next step).
   - `ca-chain.pem`: concatenated CA certificate chain (download from the CA).

##### Option 2: Letâ€™s Encrypt (public CA)

If the device has a public domain, use Letâ€™s Encrypt:

1. Use the ACME protocol for automation.
2. Complete domain validation (HTTP-01 or DNS-01).
3. Receive a free 90-day certificate.

**Note**: Letâ€™s Encrypt is best for public-facing services; for internal networks, an enterprise CA is recommended.

##### Option 3: Manual Signing via PKI Team

1. Send the CSR to the PKI administrator (email, ticket).
2. Wait for review and signing.
3. Receive the signed certificate (`.crt` or `.pem` file).

#### Timing

- ğŸš€ Automated CAs: minutes to seconds
- â³ Manual CAs: hours to days, depending on the approval chain

#### Files You Should Receive

| File | Required | Description | Format |
|------|----------|-------------|--------|
| **Device Certificate** | âœ… Yes | CA-signed certificate for the device | `device.crt`, PEM format |
| **CA Chain** | âœ… Yes | Root CA plus intermediate CA certificates | `ca-chain.pem`, PEM format |

Once you have both files, proceed to Section 5.3.4: Install the device certificate.

---
#### 5.3.2 Generate CSR (Certificate Signing Request)

**Purpose**: Produce a CSR to submit to a CA for certificate signing.

**Prerequisites**:
- âœ… Step 5.3.1 (key pair generated)
- âœ… The **â€œğŸ“‹ Generate CSRâ€** button is enabled

**Steps**:
1. Click **â€œğŸ“‹ Generate CSR.â€**
2. Fill out the CSR details in the modal:

| Field | Required | Description | Example |
|-------|----------|-------------|---------|
| **Device ID (CN)** | âŒ No | Common Name identifying the device. Leave blank to use defaults. | `TIANSHAN-RM01-0001`, `DEVICE-AGX-001` |
| **Organization (O)** | âŒ No | Company or organization name | `HiddenPeak Labs`, `My Company` |
| **Organizational Unit (OU)** | âŒ No | Department or unit | `Device`, `Production`, `IoT` |

**Notes**:
- CN should follow a structured naming pattern (`prefix-model-serial`).
- O and OU are optional fields for metadata.
- Leaving everything blank lets the system apply defaults (e.g., MAC address-based CN).

3. Click **â€œğŸ“‹ Generate CSR.â€**
4. Wait ~2-3 seconds as the device:
   - Uses the private key and input data to craft a CSR.
   - Produces an X.509-compliant CSR (RFC 2986).
5. After completion, the modal displays:
   ```
   CSR content (copy for CA signing)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ -----BEGIN CERTIFICATE REQUEST-----       â”‚
   â”‚ MIIBVTCByQIBADBGMQswCQYDVQQGEwJVUzEWMBQG â”‚
   â”‚ A1UECgwNSGlkZGVuUGVhayBMYWJzMR8wHQYDVQ â”‚
   â”‚ ... (Base64-encoded CSR) ...              â”‚
   â”‚ -----END CERTIFICATE REQUEST-----         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```
6. Click **â€œğŸ“‹ Copy to Clipboard.â€**
7. Optionally save the CSR as a file (`device.csr`) for CA submission.

#### CSR Contents

- âœ… The deviceâ€™s public key (from the generated key pair).
- âœ… Subject information (CN, O, OU).
- âœ… Device signature proving possession of the private key.
- âŒ **No private key data** is included.

#### Next Step

Submit the CSR to your CA for signing as described in Section 5.3.3.

---
### 5.3 Full Certificate Request Flow

Configuring mTLS from scratch involves five steps.

#### Process Overview

```
Step 1: Generate key pair (on-device)
   â†“
Step 2: Generate CSR (on-device)
   â†“
Step 3: Submit to CA for signing (external)
   â†“
Step 4: Install device certificate (on-device)
   â†“
Step 5: Install CA certificate chain (on-device)
```

---

#### 5.3.1 Generate Key Pair

**Goal**: Create an ECDSA P-256 key pair on the device for CSR generation and TLS handshakes.

**Steps**:
1. **Check status**:
   - Look at the certificate status card. If it already shows â€œKey pair generated,â€ skip unless you need to regenerate.
2. **Click â€œğŸ”‘ Generate Key Pair.â€**
3. **Review the prompt**:
   ```
   Generate an ECDSA P-256 key pair for mTLS authentication.
   ```
4. **Handle the overwrite warning**:
   - If keys already exist, a yellow warning appears:
     ```
     âš ï¸ A key pair already exists. Continue will overwrite the current keys!
     ```
   - Overwriting will invalidate any CSR/certificate issued by the old key.
   - Only proceed if you understand the impact.
5. **Start generation** by clicking **â€œğŸ”‘ Generate.â€**
6. **Wait for completion**:
   - ECDSA P-256 generation takes ~3-5 seconds.
   - The modal displays progress or status.
7. **Confirm success**:
   - It shows â€œâœ… Key pair generated successfully.â€
   - Close the modal.
   - The status card now shows â€œKey pair generated, certificate not installed.â€
   - The buttons for generating CSR, installing certificates, and installing the CA become active.

#### Technical Details

- **Key type**: ECDSA P-256 (256-bit elliptic curve)
  - Benefits: fast generation, strong security, small key size.
  - Standard: NIST P-256 / secp256r1.
- **Storage**: Stored in device NVS (non-volatile storage) and persists across reboots.
- **Usage**:
  - Device HTTPS server certificate.
  - mTLS client certificate when connecting to other mTLS services.
- **Security**: Private key never leaves the device.

---
### 5.2 Check Certificate Status

#### Status Card Details

At the top of the â€œğŸ”’ HTTPS Certificatesâ€ block, a status card shows the certificate state in real time.

#### Status Icons and Meaning

| Icon | Status Text | Meaning |
|------|-------------|---------|
| ğŸ”„ | Loading... | Retrieving certificate status |
| ğŸ”’ | Key pair not generated | No key pair exists yet |
| ğŸ“ | Key pair generated, certificate not installed | Keys exist but CA certificate is missing |
| âœ… | Activated | Certificate installed and valid |
| âš ï¸ | Expiring soon | Certificate expires within 30 daysâ€”renew promptly |
| âŒ | Expired | Certificate is invalid; mTLS cannot run |

#### Certificate Details (Installed)

When the certificate shows â€œActivatedâ€ or â€œExpiring soon,â€ the card expands to reveal:

| Field | Info | Example |
|-------|------|---------|
| **Subject CN** | Device identifier (Common Name) | `TIANSHAN-RM01-0001` |
| **Issuer** | Signing CA name | `TianShanOS Intermediate CA` |
| **Valid From** | Certificate start time | `2026-01-27 00:00:00` |
| **Expires On** | Certificate end time | `2027-01-27 00:00:00` |
| **Serial Number** | Hexadecimal identifier | `01:23:45:67:89:AB` |
| **Validity** | Is the certificate currently valid? | âœ… Valid / âŒ Expired |
| **Days Remaining** | Days until expiration | `365 days`, `28 days` (warning appears if < 30) |

#### Button States

Six action buttons are located beneath the HTTPS certificate block. Their enabled/disabled state depends on the current status:

| Button | No Key Pair | Key Pair Generated | Certificate Installed | Notes |
|--------|-------------|--------------------|------------------------|-------|
| ğŸ”‘ Generate Key Pair | âœ… Enabled | âœ… Enabled | âœ… Enabled | Always available (will overwrite existing keys). |
| ğŸ“‹ Generate CSR | âŒ Disabled | âœ… Enabled | âœ… Enabled | Requires an existing key pair. |
| ğŸ“¥ Install Certificate | âŒ Disabled | âœ… Enabled | âœ… Enabled | Requires key pair. |
| ğŸ›ï¸ Install CA | âŒ Disabled | âœ… Enabled | âœ… Enabled | Requires key pair. |
| ğŸ‘ï¸ View Certificate | âŒ Disabled | âŒ Disabled | âœ… Enabled | Needs an installed certificate. |
| ğŸ—‘ï¸ Delete Credentials | âŒ Disabled | âœ… Enabled | âœ… Enabled | Available when keys or certificates exist. |

---
## FAQs & Troubleshooting

### 7.1 Key Management Issues

#### Q1: â€œStorage fullâ€ when generating a key?

**Symptom**: Clicking â€œGenerateâ€ shows â€œNVS storage fullâ€ or â€œMaximum number of keys reached.â€

**Cause**: The NVS partition (48 KB) can hold roughly:
- 8 RSA-4096 keys
- 12 RSA-2048 keys
- 32 ECDSA P-256 keys

**Fix**:
1. View the Key Management list.
2. Delete keys you no longer need (after revoking them on deployed hosts).
3. Generate the new key again.

**Recommendations**:
- Regularly clean up expired or unused keys.
- Prefer ECDSA P-256 for less space usage.
- Avoid creating too many RSA-4096 keys.

---
</applyPatch-WÃ¼rttemberguspend>
## Best Practices

### 8.1 SSH Key Management Best Practices

#### 1. Key naming conventions

**Recommended patterns**:
- `<purpose>_<environment>`: `agx_prod`, `lpmu_test`
- `<host>_<user>`: `server01_root`, `gateway_admin`
- `<project>_<seq>`: `project_a_01`, `iot_device_001`

**Avoid**:
- âŒ `key1`, `test`, `temp`
- âŒ Non-ASCII or special characters
- âŒ Excessively long names

#### 2. Selecting key types

**Suggested approach**:
- ğŸ¯ Daily work: RSA 2048-bit (speed plus compatibility)
- ğŸ¯ High-security: RSA 4096-bit (stronger but slower)
- âš ï¸ ECDSA: Use only for HTTPS certificates, not SSH

**Capacity planning**:
- RSA 2048: ~12 keys
- RSA 4096: ~8 keys
- Mix based on server criticality

#### 3. Controlling private key export

Best practices:
- ğŸ”’ Production keys: leave â€œAllow Private Key Exportâ€ unchecked.
- ğŸ”“ Backup keys: enable export and store in offline media.
- ğŸ§ª Test keys: keep non-exportable and regenerate if needed.

**Export checklist**:
- [ ] Export is necessary (backup/migration)
- [ ] Use encrypted channels (encrypted USB, VPN)
- [ ] Place backups in secure storage (password managers, encrypted drives)
- [ ] Delete temporary files after use
- [ ] Review who has access to the exported key

#### 4. Regular key audits

Recommended cadence:
- ğŸ—“ï¸ Quarterly: Review key list, delete unused entries.
- ğŸ—“ï¸ Semi-annually: Audit deployed hosts; revoke unnecessary access.
- ğŸ—“ï¸ Annually: Rotate keys for critical servers.

**Audit checklist**:
- [ ] Which keys havenâ€™t been used recently?
- [ ] Are any keys deployed to decommissioned servers?
- [ ] Any test keys lingering?
- [ ] Is storage capacity nearing its limit?

---
### 7.5 Permission & Authentication Questions

#### Q16: Can admin users use all security page functions?

**Answer**: âœ… Yes.

**admin privileges**:
- âœ… Access to every security page feature.
- âœ… Access to System, Network, and Files pages.
- âŒ Cannot access Terminal, Automation, or Command pages (root only).

**Security page capabilities**:
- âœ… Generate, delete, and export SSH keys.
- âœ… Deploy and revoke public keys on remote servers.
- âœ… Manage deployed host records.
- âœ… View/delete known host fingerprints.
- âœ… Generate, install, and delete HTTPS certificates.
- âœ… Generate CSRs and install CA chains.

**Need root functionality?**
- Contact your administrator to log in as root.
- Or request a privilege escalation to root if justified.

---

#### Q17: â€œInsufficient permissionsâ€ when exporting private keys?

**Symptom**: The **â€œğŸ” Private Keyâ€** button is greyed out or shows â€œExport not allowed.â€

**Reason**: The key was created without â€œAllow Private Key Export.â€

**Security rationale**:
- Private keys are sensitive; theyâ€™re non-exportable by default.
- Only keys explicitly marked as exportable can release their private part.
- This limitation is independent of admin/root status; it is a property of the key.

**Solutions**:

**Option 1: Create a new exportable key**
1. Generate a key with **â€œAllow Private Key Exportâ€** enabled.
2. Export as needed after creation.
3. Deploy the new key.

**Option 2: Export the public key instead**
- Every key allows public key export.
- Public keys are safe to share.

**Option 3: Accept the restriction**
- If the key is in production, leaving it non-exportable increases security.
- Use the WebUI deploy feature instead of exporting the private key.

**Design principle**:
- ğŸ”’ Private keys are the most sensitive assetsâ€”minimize export.
- ğŸ”’ Only export when necessary (backup/migration).
- ğŸ”’ Defaults prevent accidental leaks.

---
#### Q14: Certificate state shows â€œExpiring soonâ€?

**Symptom**: The status card shows âš ï¸ â€œExpiring soonâ€ with remaining days < 30.

**Recommendations**:
- ğŸŸ¢ **30-15 days**: Prepare to renew, but not urgent yet.
- ğŸŸ¡ **15-7 days**: Renew as soon as possible to avoid service impact.
- ğŸ”´ **<7 days**: Handle immediately.

**Renewal steps (keep the same key)**:
1. Click **â€œğŸ“‹ Generate CSRâ€** (you can reuse the same CN).
2. Submit the CSR to your CA and request renewal.
3. Install the new certificate via **â€œğŸ“¥ Install Certificate.â€** Paste the renewed certificate; the old one is overwritten.
4. Check the status card reflects the new expiration and days remaining.

**Notes**:
- âœ… Old certificate remains usable until it expires.
- âœ… The new certificate becomes active immediately.
- âœ… The CA chain usually does not timeout at the same time; update only if necessary.
- âš ï¸ If the CA chain itself is expired, renew it along with the device certificate.

---

#### Q15: Will HTTPS work after deleting credentials?

**Answer**: It depends on your setup. Possible outcomes:

**Scenario 1: Downgrade to HTTP**
- HTTPS is disabled; WebUI falls back to HTTP (port 80).
- Security decreases as data travels over plaintext.

**Scenario 2: Self-signed certificate**
- The system creates a temporary self-signed certificate.
- Browsers show â€œCertificate not trusted.â€
- Manual trust is required to proceed.

**Scenario 3: Service stops**
- If mTLS is mandatory, HTTPS connections will be refused until you reinstall credentials.

**Advice**:
- Plan ahead before deleting credentials.
- Testing environments can delete without impact.
- Production systems should install a replacement certificate before removing the old one.

---
#### Q13: â€œCertificate and private key do not matchâ€?

**Symptom**: After pasting the certificate, the error shows â€œCertificate and private key do not match.â€

**Cause**:
- The certificate was not signed with the current device key pair.
- Possible reasons:
  - The CSR came from another device.
  - The key pair was regenerated after the CSR was created.
  - The CA used the wrong CSR.

**Fix**:

**Option 1: Regenerate the CSR**
1. Click **â€œğŸ“‹ Generate CSRâ€** again on the device.
2. Copy the new CSR.
3. Submit it to the CA.
4. Install the newly signed certificate.

**Option 2: Delete credentials and restart**
1. Click **â€œğŸ—‘ï¸ Delete Credentials.â€**
2. Begin from Section 5.3.1 (generate key pair).
3. Follow the full flow to ensure CSR, signing, and installation all use the same key.

**Prevention**:
- âœ… Do not regenerate the key pair after creating a CSR.
- âœ… Confirm the CSR filename (e.g., `device-001.csr`) and certificate file correspond.
- âœ… Label files clearly to avoid confusion.

---
### 7.4 HTTPS Certificate Issues

#### Q12: â€œGenerate CSRâ€ button is greyed out?

**Symptom**: The **â€œğŸ“‹ Generate CSRâ€** button is disabled (greyed).

**Reason**: A key pair has not been generated. CSR signing requires a private key.

**Fix**:
1. Click **â€œğŸ”‘ Generate Key Pair.â€**
2. Wait for the key pair to finish.
3. The CSR button (and Install Certificate/Install CA buttons) will enable automatically.

**Related buttons**:
- â€œInstall Certificateâ€ and â€œInstall CAâ€ also depend on a generated key pair.
- Only â€œGenerate Key Pairâ€ and â€œDelete Credentialsâ€ are always active.

---
#### Q10: How to handle Host Fingerprint mismatch warnings?

**Symptom**: A red warning pops up: â€œâš ï¸ Security Warning: Host fingerprint mismatch.â€

**Correct handling** (see Section 4.4):

1. **ğŸ›‘ Stop immediately**: Do not click â€œUpdate Host Keyâ€ without confirmation.
2. **ğŸ“ Contact the administrator**: Ask if the server was rebuilt or the host key changed.
3. **âœ… If legitimate**: Click â€œUpdate Host Key,â€ then reconnect and trust the new fingerprint.
4. **âŒ If uncertain**: Click â€œCancelâ€ and investigate the network/security environment.

**Mistakes to avoid**:
- âŒ Clicking â€œUpdate Host Keyâ€ automatically (could signal an MITM attack).
- âŒ Ignoring the warning and forcing the connection.
- âŒ Assuming itâ€™s a bugâ€”this is a critical security feature.

**Security reminder**:
- ğŸ”´ A fingerprint mismatch is a serious warning.
- ğŸ”´ Always verify before trusting.
- ğŸ”´ Frequent warnings may indicate an insecure network.

---

#### Q11: How to verify host fingerprints?

**Scenario**: You need to confirm a serverâ€™s fingerprint (first-time connection or mismatch).

**Method 1: Get the fingerprint from the server**:
1. Log into the server through console or a trusted channel.
2. Run:
   ```bash
   # ECDSA
   ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub

   # ED25519
   ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub

   # RSA
   ssh-keygen -lf /etc/ssh/ssh_host_rsa_key.pub
   ```
3. Output example:
   ```
   256 SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01= root@server (ECDSA)
   ```
4. Compare the `SHA256:...` string with the one displayed.
   - They must match exactly (character-by-character).

**Method 2: Ask the administrator for the official fingerprint.**
**Method 3: Use another trusted device**:
1. From a verified device, SSH into the server.
2. Record the fingerprint shown there.
3. Compare it to the TianshanOS warning.

**Security tip**:
- High-security environments (finance, healthcare) should verify fingerprints before connecting.
- Internal test environments may take a more relaxed approach.

---
### 7.3 Known Host Fingerprint Issues

#### Q9: The Known Host Fingerprints list is empty?

**Symptom**: The list reads â€œNo known hostsâ€ even after you connected to SSH servers.

**Possible Causes**:

**Cause 1: You truly havenâ€™t connected yet**
|- Solution: Connect once (deploy or use the key). After trusting the host, the list will populate.

**Cause 2: Initialization bug (known issue)**
|- Behavior: Youâ€™ve connected and trusted hosts, yet the list stays empty until you refresh the page.
|- Reason: The `ts_known_hosts` module uses delayed initialization and may not start during the security service startup.
|- Fix: Trigger an SSH connection to initialize, then refresh the security page.

**Cause 3: NVS data corruption**
|- Symptom: The CLI `hosts --list` command also shows nothing.
|- Fix: Reconnect to each host and trust them again to rebuild the records.

**To verify records** (requires root terminal access):
```bash
# View hosts
hosts --list

# View JSON details
hosts --list --json
```

---
#### Q8: The Deployed Hosts list is empty?

**Symptom**: You deployed a key, yet the table still shows â€œNo deployed hosts.â€

**Cause**: Only hosts deployed via the WebUI appear in the list.

**Not recorded scenarios**:
- âŒ Deployments via CLI (`ssh --copyid`).
- âŒ Manually appending the public key to `authorized_keys`.
- âŒ Keys deployed on other devices or via different tools.

**Resolution**:
- If you want WebUI management, redeploy the key through the UI.
- Alternatively, use CLI commands like `hosts --deployed` to view/manage hosts.

**Design note**:
- Records are stored locally in `ts_ssh_hosts_config`.
- Only WebUI or specific API deployments are tracked to provide a unified management interface.

---
#### Q7: Deployment succeeded but password is still requested?

**Symptom**: The deployment dialog shows success, yet passwordless SSH still prompts for a password.

**Possible Causes**:
1. `authorized_keys` permissions are incorrect.
2. SSH configuration does not permit public key authentication.
3. Home directory or `.ssh` directory permissions are too permissive.
4. SELinux context issues (on RHEL/CentOS).

**Fix**:

1. **Check permissions** on the server:
   ```bash
   ls -ld ~/.ssh
   ls -l ~/.ssh/authorized_keys

   # Correct permissions:
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
2. **Inspect file contents**:
   ```bash
   cat ~/.ssh/authorized_keys
   ```
   Ensure it contains a line starting with `ssh-rsa` or `ecdsa-sha2-`.
3. **Verify SSH configuration**:
   ```bash
   sudo cat /etc/ssh/sshd_config | grep -E "PubkeyAuthentication|AuthorizedKeysFile"

   # Confirm:
   PubkeyAuthentication yes
   AuthorizedKeysFile .ssh/authorized_keys
   ```
4. **Check SELinux** (if applicable):
   ```bash
   restorecon -R ~/.ssh
   ```
5. **Restart SSH** if configuration changed:
   ```bash
   sudo systemctl restart sshd
   ```

---
#### Q6: â€œAuthentication failedâ€ during deployment?

**Symptom**: After entering the password, the UI shows â€œAuthentication failedâ€ or â€œWrong password.â€

**Possible Causes**:
1. Password typos (case, special characters).
2. Incorrect username.
3. SSH server disallows password authentication.
4. Account is locked.

**Fix**:

1. **Recheck the password**:
   - SSH passwords are case sensitive.
   - Watch for spaces or quotes.
   - Test the password on another system.
2. **Confirm the username**:
   - Verify the correct account name.
   - Some systems disable password login for `root`.
3. **Review SSH configuration**:
   ```bash
   sudo cat /etc/ssh/sshd_config | grep PasswordAuthentication

   # Ensure the line reads:
   PasswordAuthentication yes

   # Restart SSH to apply changes:
   sudo systemctl restart sshd
   ```
4. **Check account status**:
   ```bash
   sudo passwd -S <username>
   ```

---
### 7.2 Deployment & Connection Issues

#### Q5: â€œConnection timeoutâ€ during deployment?

**Symptom**: The deployment process hangs and returns â€œConnection timeout.â€

**Possible Reasons**:
1. Network is unreachable (device cannot reach the target host).
2. SSH service is down on the host.
3. Firewalls block port 22 (or a custom port).
4. IP address or port is misentered.

**Troubleshooting**:

**Step 1: Check connectivity**
- If you have terminal access, run `ping <host>`.
- Alternatively, ping from another device.

**Step 2: Check SSH service**
- On the server: `systemctl status sshd` or `service ssh status`.
- Ensure SSH is active.

**Step 3: Inspect firewall rules**
- Outbound SSH must be allowed from the device.
- Inbound SSH (port 22 or custom) must be allowed on the server.
  ```bash
  sudo ufw status
  sudo firewall-cmd --list-all
  ```

**Step 4: Confirm parameters**
- Verify IP, port, and username.
- Try connecting from another machine to ensure the server is reachable.

---
#### Q2: ECDSA keys fail to connect via SSH?

**Symptom**: Deploying or using an ECDSA key fails with authentication errors like â€œAuthentication failedâ€ or â€œUnsupported key type.â€

**Cause**: The current TianshanOS SSH client does not support ECDSA public key authentication (known limitation).

**Fix**:
1. Delete the ECDSA key.
2. Generate a new key using **RSA 2048-bit** or **RSA 4096-bit**.
3. Redeploy the new key.

**Note**:
- ECDSA keys are still supported for HTTPS certificates.
- SSH ECDSA support will be added in a future release.

---

#### Q3: How to back up keys?

**Scenario**: You worry about device failure or firmware upgrades erasing keys.

**Method 1: Export the private key (requires prior permission)**:
1. Enable **â€œAllow Private Key Exportâ€** when generating the key.
2. After creation, click **â€œğŸ” Private Key.â€**
3. Download the `.pem` file.
4. Store it on encrypted offline media (USB drive, password manager).

**Method 2: Document the key metadata**:
1. Record the key ID, type, and notes.
2. List which servers it is deployed to.
3. If lost, regenerate and redeploy the key.

**Recommendation**:
- Production keys: enable export and secure backup.
- Test keys: skip backup and regenerate if needed.

---

#### Q4: Can a deleted key be restored?

**Answer**: âŒ **No.**

**Details**:
- Deletion removes the key from NVS permanently.
- There is no recycle bin or undo feature.
- The only recovery method is to import a previously exported private key.

**Pre-deletion Checklist**:
1. âœ… Confirm the key is not on critical servers.
2. âœ… Revoke or remove deployments.
3. âœ… Export the private key if a backup is needed.
4. âœ… Notify teammates who rely on the key.

**If mistakenly deleted**:
- With a backup: use `key --import` through the CLI to restore.
- Without a backup: regenerate and redeploy a new key.

---
## Reference Documents

The following docs provide additional technical depth and troubleshooting guidance. They will be accessible through Mintlify once published.

### Deep Technical Details

- **â€œSecurity Implementationâ€**:
  - Defines security levels (L1-L4).
  - Explains key storage (NVS encryption, capacity).
  - Details SSH authentication methods (password, public key, secure storage).
  - Covers WebUI authentication (user roles, permissions, session handling).

- **â€œPKI Designâ€**:
  - Describes the mTLS architecture.
  - Explains the CA hierarchy (Root CA, Intermediate CA).
  - Details certificate types and policies.
  - Outlines device activation steps.
  - Documents certificate update mechanisms.

### Command-Line Operations

- **â€œCommand Referenceâ€**:
  - `key`: All CLI key management commands.
  - `ssh`: Full parameter set for SSH connections, deployments, and revocations.
  - `hosts`: CLI management for known hosts and deployed hosts.
  - `cert` (if available): CLI certificate operations.

### Troubleshooting

- **â€œTroubleshootingâ€**:
  - SSH connection debugging.
  - Solutions when the known host list stays empty.
  - Certificate validation failure steps.
  - Network diagnostics.

### Quick Start

- **â€œQuick Startâ€**:
  - Overview of TianshanOS.
  - WebUI navigation guidance.
  - A brief introduction to the Security page.
  - First-time configuration steps.

---
### 8.4 Certificate Management Best Practices

#### 1. Renew in advance

**Renewal timeline**:
- ğŸ“… **>30 days left**: Routine check; no action required.
- ğŸ“… **30-15 days left**: Prepare renewal and contact the CA.
- ğŸ“… **15-7 days left**: Execute the renewal process.
- ğŸ“… **<7 days**: Treat as high priority.

**Reminder suggestions**:
- Set calendar alerts 30 days before expiration.
- Use monitoring systems to watch certificate status.

#### 2. Back up the CA chain

**Why backup**:
- The CA chain is common across devices tuned to the same PKI.
- Backups let you repurpose the chain without re-downloading it.
- You can still validate device certificates if the CA server is unreachable.

**How to backup**:
1. Click â€œView Certificateâ€ to copy the device certificate.
2. Save the CA chain as `ca-chain.pem`.
3. Store them in a secure document system or configuration repository.

**Usage**:
- Apply to new devices quickly.
- Serve as a fallback if the CA server is offline.

#### 3. Test renewal workflows in a lab

**For multi-device deployments**:
1. Execute the full certificate process on a test device first.
2. Verify the certificate works and mTLS connections succeed.
3. Once validated, roll out to production devices.

**Checklist**:
- [ ] Certificate installed successfully?
- [ ] HTTPS service starts without errors?
- [ ] mTLS works both ways?
- [ ] Clients can still connect?

#### 4. Regularly inspect certificate health

**Inspection frequency**:
- ğŸ—“ï¸ Monthly: Check the status card.
- ğŸ—“ï¸ Quarterly: Review certificate details for anomalies.
- ğŸ—“ï¸ After major changes: Revalidate certificate integrity.

**Inspection items**:
- [ ] Status is â€œActivated.â€
- [ ] Validity exceeds 30 days.
- [ ] The CN is correct.
- [ ] The issuer is the expected CA.

---
### 8.3 Host Fingerprint Management Best Practices

#### 1. Verify during the first connection

**Standard workflow (high security)**:
1. Obtain the official fingerprint from the administrator.
2. Compare it with the one shown when connecting.
3. Once confirmed, type `yes` to trust.
4. Document when and who verified the fingerprint.

**Simplified workflow (internal testing)**:
1. Confirm the IP address is correct.
2. Type `yes` to trust.
3. Rely on automatic verification afterward.

#### 2. Responding to mismatches

**Golden rule**: **Always treat fingerprint mismatches seriously.**

**Priority order**:
1. ğŸ”´ Verify whether the server was rebuilt or keys changed.
2. ğŸŸ¡ Investigate the network environment (untrusted Wi-Fi, proxies).
3. ğŸŸ¢ Update the host key only after confirming legitimacy.

**Record changes**:
- Log who updated the fingerprint, why, and when.
- Retain evidence of server reinstallation or key rotation.

#### 3. Regular cleanup

**Targets**:
- Retired servers.
- Reused IP addresses.
- Temporary testing hosts.

**Actions**:
- Quarterly review of Known Host Fingerprints.
- Delete entries no longer in use.
- Keep the list tidy for easier management.

---
### 8.2 Deployment Management Best Practices

#### 1. Document deployments

**Use a spreadsheet or documentation table**:

| Key ID | Deployed Host | Username | Purpose | Deployment Date | Owner |
|--------|---------------|----------|---------|-----------------|-------|
| agx_prod | 192.168.1.100 | nvidia | AGX monitoring | 2026-01-30 | Alice |
| lpmu_test | 10.10.99.50 | root | LPMU testing | 2026-01-28 | Bob |

**Benefits**:
- Simplifies maintenance and auditing.
- Helps during personnel transitions.
- Speeds up incident response.

#### 2. Test immediately after deployment

**Workflow**:
1. After deployment, click **â€œğŸ” Test.â€**
2. Ensure the connection succeeds.
3. If it fails, fix issues immediately.

**Test items**:
- Connection success
- Correct username
- Command execution works

#### 3. Revoke access you no longer need

When:
- ğŸš« Projects finish.
- ğŸ”„ Employees leave.
- ğŸ”’ Servers are retired or moved.

**Action**:
1. Click â€œRevokeâ€ from the Deployed Hosts list.
2. Or remove the entry from the serverâ€™s `authorized_keys`.

#### 4. Maintain a key rotation plan

**Strategy**:
- ğŸ”„ Rotate critical server keys annually.
- ğŸ”„ Rotate regular server keys every 2â€“3 years or as required.
- ğŸ”„ Rotate test keys after the project ends.

**Rotation steps**:
1. Generate the new key (`agx_2027`).
2. Deploy it to servers.
3. Test connectivity.
4. Revoke the old key.
5. Delete the old key.

---
## Conclusion

This document covers every feature and workflow on the TianshanOS Security page. As an **admin user**, you now know how to manage SSH keys, remote host connections, and HTTPS certificates.

**Recommendations**:
1. ğŸ“– Read this guide fully before using the security page for the first time.
2. ğŸ§ª Practice the workflows in a test environment first.
3. ğŸ”– Bookmark this page for quick reference.
4. ğŸ“š Dive into the referenced technical docs for advanced topics.

**Safety reminders**:
- ğŸ” Keep keys and certificates protected.
- ğŸš¨ Treat all security warnings (e.g., fingerprint mismatches) seriously.
- ğŸ”„ Regularly review and rotate keys/certificates.
- ğŸ“‹ Log important changes and operations.

If you have questions or suggestions, contact your system administrator or consult the project documentation library.
## Secure Storage vs. File-Based Keys

This section explains why TianshanOS uses secure storage (NVS) over filesystem-based keys by default.

### Comparison Table

| Feature | Secure Storage (NVS) | File Keys (SD Card) |
|---------|----------------------|--------------------|
| **Private Key Protection** | âœ… Encrypted NVS partition; extraction is difficult | âš ï¸ Plaintext PEM files that can be copied or leaked |
| **Usability** | âœ… Only remember the Key ID; no file paths | âŒ Requires remembering file paths, which can be confusing |
| **Key Backup** | âš ï¸ Requires enabling â€œAllow Exportâ€ | âœ… Copy the file directly |
| **Cross-Device Use** | âŒ Bound to a single device | âœ… Copy to multiple devices |
| **Protection Against Accidental Deletion** | âœ… Must explicitly delete | âš ï¸ Filesystem issues can result in loss |
| **Storage Capacity** | âš ï¸ NVS has a limited capacity (8-32 keys) | âœ… SD cards have large capacity |
| **Access Speed** | âœ… Fast NVS access | âš ï¸ Slower SD card I/O |
| **Security Rating** | â­â­â­â­â­ (5 stars) | â­â­ (2 stars) |
| **Recommended Use** | ğŸ¯ Production, long-term, security-sensitive | Temporary use, key migration, multi-device sharing |

### Advantages of Secure Storage

1. **Hardware-backed protection**:
   - NVS partitions support flash encryption (recommended in production).
   - Private keys are hard to extract physically.
2. **Default security**:
   - Keys cannot be exported unless explicitly allowed.
   - Prevents accidental leaks.
3. **Centralized management**:
   - All keys are viewable/manageable through the WebUI.
   - Keys are not scattered across filesystems.
4. **Access control**:
   - â€œHide Key IDâ€ prevents low-privilege users from seeing sensitive identifiers.
   - â€œAllow exportâ€ flag enables fine-grained controls.

### When to Use File-Based Keys

Although secure storage is preferred, file keys may be appropriate when:

- ğŸ”„ **Migration**: Import an existing key from another device.
- ğŸ§ª **Temporary testing**: Use a key for a short-lived test.
- ğŸ”€ **Multi-device sharing**: The same key must run on several devices.
- ğŸ“¤ **External tooling**: Desktop SSH clients (PuTTY, Terminal) require file keys.

**CLI Example for File Keys**:
```bash
# Use a key stored on the SD card
ssh --host 192.168.1.100 --user nvidia --key /sdcard/id_rsa --shell
```

---
### 5.6 Certificate Renewal

#### When to Renew

- â° The certificate is expiring soon (start renewal 30 days before expiry).
- âš ï¸ The status card shows â€œExpiring soonâ€ or remaining days < 30.
- ğŸ“… Company PKI policy dictates issued certificates renew annually or by schedule.

#### Renewal Steps

**Option 1: Keep the same key pair (recommended)**

1. **Generate a fresh CSR**:
   - Click **â€œğŸ“‹ Generate CSRâ€** (you can reuse the same CN).
   - Copy the new CSR.
2. **Submit it to the CA**:
   - Send the CSR to your CA for renewal.
   - Receive a new certificate.
3. **Install the new certificate**:
   - Click **â€œğŸ“¥ Install Certificate.â€**
   - Paste the renewed certificate.
4. **Check the status**:
   - The expiration date should update to the new certificateâ€™s validity.
   - Days remaining should reflect the new lifetime.

**Option 2: Full refresh (if the private key may be compromised)**

1. Delete all credentials via **â€œğŸ—‘ï¸ Delete Credentials.â€**
2. Start again from Step 5.3.1 (generate a new key pair).
3. Go through the full 5.3 flow (CSR, CA signing, install certificate, install CA chain).

#### Renewal Notes

- âœ… The old certificate remains valid until its expiry.
- âœ… The new certificate takes effect immediately once installed.
- âœ… CA chains rarely need updates unless the CA infrastructure changes.
- âš ï¸ If the CA chain itself is expiring, renew it alongside the device certificate.

#### Automated Renewal (Future Feature)

Currently, renewal is manual. Future versions may:
- Detect expiring certificates automatically
- Generate CSRs and submit to ACME CAs
- Install refreshed certificates without manual intervention

---
### 5.5 Delete All PKI Credentials (Factory Reset)

**Warning**: This action wipes all HTTPS certificate data. Confirm before proceeding.

#### What Gets Deleted

Clicking **â€œğŸ—‘ï¸ Delete Credentialsâ€** removes:
- ğŸ”‘ The device private key (ECDSA P-256)
- ğŸ“„ The device certificate
- ğŸ›ï¸ The CA certificate chain

#### When to Use

| Scenario | Description |
|----------|-------------|
| **Device reconfiguration** | You need to change the device ID or PKI structure. |
| **CA changes** | Your organization replaced the CA or PKI workflow. |
| **Test reset** | Clear all test data and redo the certificate flow. |
| **Security incident** | Suspect a private key leak; start fresh. |

#### Steps

1. Click **â€œğŸ—‘ï¸ Delete Credentialsâ€** (red button).
2. Read the warning dialog:
   ```
   âš ï¸ Warning: This deletes all PKI credentials

   This action will remove:
   â€¢ Device private key
   â€¢ Device certificate
   â€¢ CA certificate chain

   After deletion:
   â€¢ mTLS will be unavailable
   â€¢ You must regenerate keys and reapply for certificates
   â€¢ This action cannot be undone

   Do you want to continue?
   ```
3. Confirm if you understand the impact.
4. After completion:
   - The status card reverts to â€œğŸ”’ Key pair not generated.â€
   - All buttons return to their initial states.
   - The HTTPS key row disappears from the Key Management table.

#### Impact

- **HTTPS service**:
  - May fall back to HTTP (if allowed).
  - Or use a temporary self-signed certificate, causing browser warnings.
  - mTLS stops working.
- **Clients**:
  - mTLS-aware clients cannot verify the device.
  - Browsers may show certificate errors.
- **Recovery**:
  - Start Section 5.3 from Step 5.3.1 again to rebuild the entire PKI.

---
### 5.4 View Installed Certificate

**Use Cases**:
- Inspect the full PEM content of the device certificate.
- Confirm certificate details (CN, validity, issuer).
- Copy the certificate for client configuration or backups.

**Steps**:
1. Ensure the device certificate is installed (the â€œğŸ‘ï¸ View Certificateâ€ button is enabled).
2. Click **â€œğŸ‘ï¸ View Certificate.â€**
3. Wait as â€œğŸ”„ Loading...â€ appears for 1-2 seconds.
4. The modal displays the entire PEM content (scrollable).
5. Optional: click **â€œğŸ“‹ Copy to Clipboardâ€** for reuse.
6. Close the modal when finished.

#### Certificate Inspection

To analyze the certificate on Linux/macOS:

```bash
# Save the certificate as device.crt, then run:
openssl x509 -in device.crt -text -noout
```

Sample output:
```
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 01:23:45:67:89:ab
        Signature Algorithm: ecdsa-with-SHA256
        Issuer: CN=TianShanOS Intermediate CA
        Validity
            Not Before: Jan 27 00:00:00 2026 GMT
            Not After : Jan 27 00:00:00 2027 GMT
        Subject: CN=TIANSHAN-RM01-0001, O=HiddenPeak Labs, OU=Device
        Subject Public Key Info:
            Public Key Algorithm: id-ecPublicKey
                Public-Key: (256 bit)
```

---
#### 5.3.5 Install the CA Certificate Chain

**Purpose**: Install the CA chain (root + intermediate) so clients can validate the device certificate.

**Prerequisites**:
- âœ… Device certificate installed (Section 5.3.4).
- âœ… CA chain file in PEM format.

**Why you need it**:
- Clients need a complete trust path: `Device Cert â† Intermediate CA â† Root CA`.
- Without it, browsers or clients will show â€œUnable to verify certificate.â€

**Steps**:
1. Prepare the CA chain file (e.g., `ca-chain.pem`) containing root and intermediate certificates.
2. Open the file and copy everything:
   ```
   -----BEGIN CERTIFICATE-----
   (Root CA content)
   -----END CERTIFICATE-----
   -----BEGIN CERTIFICATE-----
   (Intermediate CA content)
   -----END CERTIFICATE-----
   ```
3. Click **â€œğŸ›ï¸ Install CA.â€**
4. Paste the chain into the modalâ€™s text box (all `BEGIN/END` sections).
5. Click **â€œğŸ›ï¸ Install.â€**
6. Wait for validation and storage in NVS.
7. Confirmation steps:
   - â€œâœ… CA chain installed successfully.â€
   - Status card shows â€œâœ… Activatedâ€ (if the certificate is valid).
   - mTLS configuration is now complete.

#### CA Chain Examples

**Single-level CA**:
```
-----BEGIN CERTIFICATE-----
(Self-signed root CA)
-----END CERTIFICATE-----
```

**Two-level CA**:
```
-----BEGIN CERTIFICATE-----
(Root CA)
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
(Intermediate CA)
-----END CERTIFICATE-----
```

- Multiple certificate blocks are acceptable (root + intermediates).
- Order is not critical; the system auto-detects root vs. intermediates.
- For simple setups, a single root block suffices.

#### Post-installation Validation

1. Check the status card:
   - Should read â€œâœ… Activatedâ€
   - Validity shows â€œâœ… Validâ€
   - Days remaining should be accurate
2. Test an mTLS client (configured to trust the same CA):
   - Connect to the device using an mTLS-aware client.
   - Ensure dual authentication succeeds.

---
#### 5.3.4 Install the Device Certificate

**Goal**: Install the CA-signed device certificate so mTLS works.

**Prerequisites**:
- âœ… Key pair must exist.
- âœ… You have the signed certificate in PEM format.
- âœ… The certificate was signed from the CSR you generated.

**Steps**:
1. Open the certificate file (`device.crt`) on your computer.
2. Copy its entire PEM block:
   ```
   -----BEGIN CERTIFICATE-----
   MIICxzCCAa+gAwIBAgIRAMxBxOxxxxxxxxxxxxxxxxxxxxxxxx
   (Base64 lines)
   xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxQ=
   -----END CERTIFICATE-----
   ```
3. Click **â€œğŸ“¥ Install Certificate.â€**
4. Paste the certificate into the â€œCertificate PEMâ€ field, ensuring the `BEGIN/END` lines are present.
5. Click **â€œğŸ“¥ Install.â€**
6. Wait while the system validates:
   - âœ… Correct PEM format
   - âœ… Certificate matches the private key
   - âœ… Certificate is currently valid (within its validity window)
   - âœ… Subject fields look as expected
7. Confirm when the modal shows:
   - â€œâœ… Certificate installed successfullyâ€
   - Displayed certificate details (CN, issuer, validity)
   - Status card updates to â€œActivatedâ€ or â€œCertificate installed, CA chain missingâ€

#### Common Errors

| Error Message | Cause | Resolution |
|---------------|-------|------------|
| **Certificate and private key do not match** | CA signed a CSR from another device | Generate a new CSR and resubmit, or delete credentials and restart |
| **Invalid certificate format** | PEM headers missing or corrupted | Verify the copied content includes `-----BEGIN/END CERTIFICATE-----` |
| **Certificate expired** | You installed a past-dated certificate | Ask the CA for a new certificate |
| **Unable to parse certificate** | The file is corrupted | Download or copy the certificate again |

#### How Matching Works

The system:
1. Extracts the public key from the certificate.
2. Loads the private key from NVS.
3. Verifies they form a key pair.
4. Allows installation only when they match.

**Why it matters**: A mismatched certificate canâ€™t complete TLS handshakes and will break HTTPS.

---
#### 5.3.3 Submit to CA for Signing (External)

**Purpose**: Send the CSR to a Certificate Authority to receive the device certificate.

**Note**: This step happens outside the device. Use your CA server or contact your PKI administrator.

#### Common CA Options

##### Option 1: Internal CA (e.g., step-ca)

If your organization uses step-ca or an internal CA:

1. Access the CA server or use the `step` CLI.
2. Submit the CSR:
   ```bash
   # Save CSR as device.csr then run
   step ca certificate --csr device.csr device.crt

   # Or paste the CSR manually
   cat > device.csr << 'EOF'
   -----BEGIN CERTIFICATE REQUEST-----
   (paste CSR here)
   -----END CERTIFICATE REQUEST-----
   EOF

   step ca certificate --csr device.csr device.crt
   ```
3. Retrieve:
   - `device.crt`: the signed device certificate (needed in the next step).
   - `ca-chain.pem`: concatenated CA certificate chain (download from the CA).

##### Option 2: Letâ€™s Encrypt (public CA)

If the device has a public domain, use Letâ€™s Encrypt:

1. Use the ACME protocol for automation.
2. Complete domain validation (HTTP-01 or DNS-01).
3. Receive a free 90-day certificate.

**Note**: Letâ€™s Encrypt is best for public-facing services; for internal networks, an enterprise CA is recommended.

##### Option 3: Manual Signing via PKI Team

1. Send the CSR to the PKI administrator (email, ticket).
2. Wait for review and signing.
3. Receive the signed certificate (`.crt` or `.pem` file).

#### Timing

- ğŸš€ Automated CAs: minutes to seconds
- â³ Manual CAs: hours to days, depending on the approval chain

#### Files You Should Receive

| File | Required | Description | Format |
|------|----------|-------------|--------|
| **Device Certificate** | âœ… Yes | CA-signed certificate for the device | `device.crt`, PEM format |
| **CA Chain** | âœ… Yes | Root CA plus intermediate CA certificates | `ca-chain.pem`, PEM format |

Once you have both files, proceed to Section 5.3.4: Install the device certificate.

---
#### 5.3.2 Generate CSR (Certificate Signing Request)

**Purpose**: Produce a CSR to submit to a CA for certificate signing.

**Prerequisites**:
- âœ… Step 5.3.1 (key pair generated)
- âœ… The **â€œğŸ“‹ Generate CSRâ€** button is enabled

**Steps**:
1. Click **â€œğŸ“‹ Generate CSR.â€**
2. Fill out the CSR details in the modal:

| Field | Required | Description | Example |
|-------|----------|-------------|---------|
| **Device ID (CN)** | âŒ No | Common Name identifying the device. Leave blank to use defaults. | `TIANSHAN-RM01-0001`, `DEVICE-AGX-001` |
| **Organization (O)** | âŒ No | Company or organization name | `HiddenPeak Labs`, `My Company` |
| **Organizational Unit (OU)** | âŒ No | Department or unit | `Device`, `Production`, `IoT` |

**Notes**:
- CN should follow a structured naming pattern (`prefix-model-serial`).
- O and OU are optional fields for metadata.
- Leaving everything blank lets the system apply defaults (e.g., MAC address-based CN).

3. Click **â€œğŸ“‹ Generate CSR.â€**
4. Wait ~2-3 seconds as the device:
   - Uses the private key and input data to craft a CSR.
   - Produces an X.509-compliant CSR (RFC 2986).
5. After completion, the modal displays:
   ```
   CSR content (copy for CA signing)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ -----BEGIN CERTIFICATE REQUEST-----       â”‚
   â”‚ MIIBVTCByQIBADBGMQswCQYDVQQGEwJVUzEWMBQG â”‚
   â”‚ A1UECgwNSGlkZGVuUGVhayBMYWJzMR8wHQYDVQ â”‚
   â”‚ ... (Base64-encoded CSR) ...              â”‚
   â”‚ -----END CERTIFICATE REQUEST-----         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```
6. Click **â€œğŸ“‹ Copy to Clipboard.â€**
7. Optionally save the CSR as a file (`device.csr`) for CA submission.

#### CSR Contents

- âœ… The deviceâ€™s public key (from the generated key pair).
- âœ… Subject information (CN, O, OU).
- âœ… Device signature proving possession of the private key.
- âŒ **No private key data** is included.

#### Next Step

Submit the CSR to your CA for signing as described in Section 5.3.3.

---
### 5.3 Full Certificate Request Flow

Configuring mTLS from scratch involves five steps.

#### Process Overview

```
Step 1: Generate key pair (on-device)
   â†“
Step 2: Generate CSR (on-device)
   â†“
Step 3: Submit to CA for signing (external)
   â†“
Step 4: Install device certificate (on-device)
   â†“
Step 5: Install CA certificate chain (on-device)
```

---

#### 5.3.1 Generate Key Pair

**Goal**: Create an ECDSA P-256 key pair on the device for CSR generation and TLS handshakes.

**Steps**:
1. **Check status**:
   - Look at the certificate status card. If it already shows â€œKey pair generated,â€ skip unless you need to regenerate.
2. **Click â€œğŸ”‘ Generate Key Pair.â€**
3. **Review the prompt**:
   ```
   Generate an ECDSA P-256 key pair for mTLS authentication.
   ```
4. **Handle the overwrite warning**:
   - If keys already exist, a yellow warning appears:
     ```
     âš ï¸ A key pair already exists. Continue will overwrite the current keys!
     ```
   - Overwriting will invalidate any CSR/certificate issued by the old key.
   - Only proceed if you understand the impact.
5. **Start generation** by clicking **â€œğŸ”‘ Generate.â€**
6. **Wait for completion**:
   - ECDSA P-256 generation takes ~3-5 seconds.
   - The modal displays progress or status.
7. **Confirm success**:
   - It shows â€œâœ… Key pair generated successfully.â€
   - Close the modal.
   - The status card now shows â€œKey pair generated, certificate not installed.â€
   - The buttons for generating CSR, installing certificates, and installing the CA become active.

#### Technical Details

- **Key type**: ECDSA P-256 (256-bit elliptic curve)
  - Benefits: fast generation, strong security, small key size.
  - Standard: NIST P-256 / secp256r1.
- **Storage**: Stored in device NVS (non-volatile storage) and persists across reboots.
- **Usage**:
  - Device HTTPS server certificate.
  - mTLS client certificate when connecting to other mTLS services.
- **Security**: Private key never leaves the device.

---
### 5.2 Check Certificate Status

#### Status Card Details

At the top of the â€œğŸ”’ HTTPS Certificatesâ€ block, a status card shows the certificate state in real time.

#### Status Icons and Meaning

| Icon | Status Text | Meaning |
|------|-------------|---------|
| ğŸ”„ | Loading... | Retrieving certificate status |
| ğŸ”’ | Key pair not generated | No key pair exists yet |
| ğŸ“ | Key pair generated, certificate not installed | Keys exist but CA certificate is missing |
| âœ… | Activated | Certificate installed and valid |
| âš ï¸ | Expiring soon | Certificate expires within 30 daysâ€”renew promptly |
| âŒ | Expired | Certificate is invalid; mTLS cannot run |

#### Certificate Details (Installed)

When the certificate shows â€œActivatedâ€ or â€œExpiring soon,â€ the card expands to reveal:

| Field | Info | Example |
|-------|------|---------|
| **Subject CN** | Device identifier (Common Name) | `TIANSHAN-RM01-0001` |
| **Issuer** | Signing CA name | `TianShanOS Intermediate CA` |
| **Valid From** | Certificate start time | `2026-01-27 00:00:00` |
| **Expires On** | Certificate end time | `2027-01-27 00:00:00` |
| **Serial Number** | Hexadecimal identifier | `01:23:45:67:89:AB` |
| **Validity** | Is the certificate currently valid? | âœ… Valid / âŒ Expired |
| **Days Remaining** | Days until expiration | `365 days`, `28 days` (warning appears if < 30) |

#### Button States

Six action buttons are located beneath the HTTPS certificate block. Their enabled/disabled state depends on the current status:

| Button | No Key Pair | Key Pair Generated | Certificate Installed | Notes |
|--------|-------------|--------------------|------------------------|-------|
| ğŸ”‘ Generate Key Pair | âœ… Enabled | âœ… Enabled | âœ… Enabled | Always available (will overwrite existing keys). |
| ğŸ“‹ Generate CSR | âŒ Disabled | âœ… Enabled | âœ… Enabled | Requires an existing key pair. |
| ğŸ“¥ Install Certificate | âŒ Disabled | âœ… Enabled | âœ… Enabled | Requires key pair. |
| ğŸ›ï¸ Install CA | âŒ Disabled | âœ… Enabled | âœ… Enabled | Requires key pair. |
| ğŸ‘ï¸ View Certificate | âŒ Disabled | âŒ Disabled | âœ… Enabled | Needs an installed certificate. |
| ğŸ—‘ï¸ Delete Credentials | âŒ Disabled | âœ… Enabled | âœ… Enabled | Available when keys or certificates exist. |

---
## FAQs & Troubleshooting

### 7.1 Key Management Issues

#### Q1: â€œStorage fullâ€ when generating a key?

**Symptom**: Clicking â€œGenerateâ€ shows â€œNVS storage fullâ€ or â€œMaximum number of keys reached.â€

**Cause**: The NVS partition (48 KB) can hold roughly:
- 8 RSA-4096 keys
- 12 RSA-2048 keys
- 32 ECDSA P-256 keys

**Fix**:
1. View the Key Management list.
2. Delete keys you no longer need (after revoking them on deployed hosts).
3. Generate the new key again.

**Recommendations**:
- Regularly clean up expired or unused keys.
- Prefer ECDSA P-256 for less space usage.
- Avoid creating too many RSA-4096 keys.

---
</applyPatch-WÃ¼rttemberguspend>
## Best Practices

### 8.1 SSH Key Management Best Practices

#### 1. Key naming conventions

**Recommended patterns**:
- `<purpose>_<environment>`: `agx_prod`, `lpmu_test`
- `<host>_<user>`: `server01_root`, `gateway_admin`
- `<project>_<seq>`: `project_a_01`, `iot_device_001`

**Avoid**:
- âŒ `key1`, `test`, `temp`
- âŒ Non-ASCII or special characters
- âŒ Excessively long names

#### 2. Selecting key types

**Suggested approach**:
- ğŸ¯ Daily work: RSA 2048-bit (speed plus compatibility)
- ğŸ¯ High-security: RSA 4096-bit (stronger but slower)
- âš ï¸ ECDSA: Use only for HTTPS certificates, not SSH

**Capacity planning**:
- RSA 2048: ~12 keys
- RSA 4096: ~8 keys
- Mix based on server criticality

#### 3. Controlling private key export

Best practices:
- ğŸ”’ Production keys: leave â€œAllow Private Key Exportâ€ unchecked.
- ğŸ”“ Backup keys: enable export and store in offline media.
- ğŸ§ª Test keys: keep non-exportable and regenerate if needed.

**Export checklist**:
- [ ] Export is necessary (backup/migration)
- [ ] Use encrypted channels (encrypted USB, VPN)
- [ ] Place backups in secure storage (password managers, encrypted drives)
- [ ] Delete temporary files after use
- [ ] Review who has access to the exported key

#### 4. Regular key audits

Recommended cadence:
- ğŸ—“ï¸ Quarterly: Review key list, delete unused entries.
- ğŸ—“ï¸ Semi-annually: Audit deployed hosts; revoke unnecessary access.
- ğŸ—“ï¸ Annually: Rotate keys for critical servers.

**Audit checklist**:
- [ ] Which keys havenâ€™t been used recently?
- [ ] Are any keys deployed to decommissioned servers?
- [ ] Any test keys lingering?
- [ ] Is storage capacity nearing its limit?

---
### 7.5 Permission & Authentication Questions

#### Q16: Can admin users use all security page functions?

**Answer**: âœ… Yes.

**admin privileges**:
- âœ… Access to every security page feature.
- âœ… Access to System, Network, and Files pages.
- âŒ Cannot access Terminal, Automation, or Command pages (root only).

**Security page capabilities**:
- âœ… Generate, delete, and export SSH keys.
- âœ… Deploy and revoke public keys on remote servers.
- âœ… Manage deployed host records.
- âœ… View/delete known host fingerprints.
- âœ… Generate, install, and delete HTTPS certificates.
- âœ… Generate CSRs and install CA chains.

**Need root functionality?**
- Contact your administrator to log in as root.
- Or request a privilege escalation to root if justified.

---

#### Q17: â€œInsufficient permissionsâ€ when exporting private keys?

**Symptom**: The **â€œğŸ” Private Keyâ€** button is greyed out or shows â€œExport not allowed.â€

**Reason**: The key was created without â€œAllow Private Key Export.â€

**Security rationale**:
- Private keys are sensitive; theyâ€™re non-exportable by default.
- Only keys explicitly marked as exportable can release their private part.
- This limitation is independent of admin/root status; it is a property of the key.

**Solutions**:

**Option 1: Create a new exportable key**
1. Generate a key with **â€œAllow Private Key Exportâ€** enabled.
2. Export as needed after creation.
3. Deploy the new key.

**Option 2: Export the public key instead**
- Every key allows public key export.
- Public keys are safe to share.

**Option 3: Accept the restriction**
- If the key is in production, leaving it non-exportable increases security.
- Use the WebUI deploy feature instead of exporting the private key.

**Design principle**:
- ğŸ”’ Private keys are the most sensitive assetsâ€”minimize export.
- ğŸ”’ Only export when necessary (backup/migration).
- ğŸ”’ Defaults prevent accidental leaks.

---
#### Q14: Certificate state shows â€œExpiring soonâ€?

**Symptom**: The status card shows âš ï¸ â€œExpiring soonâ€ with remaining days < 30.

**Recommendations**:
- ğŸŸ¢ **30-15 days**: Prepare to renew, but not urgent yet.
- ğŸŸ¡ **15-7 days**: Renew as soon as possible to avoid service impact.
- ğŸ”´ **<7 days**: Handle immediately.

**Renewal steps (keep the same key)**:
1. Click **â€œğŸ“‹ Generate CSRâ€** (you can reuse the same CN).
2. Submit the CSR to your CA and request renewal.
3. Install the new certificate via **â€œğŸ“¥ Install Certificate.â€** Paste the renewed certificate; the old one is overwritten.
4. Check the status card reflects the new expiration and days remaining.

**Notes**:
- âœ… Old certificate remains usable until it expires.
- âœ… The new certificate becomes active immediately.
- âœ… The CA chain usually does not timeout at the same time; update only if necessary.
- âš ï¸ If the CA chain itself is expired, renew it along with the device certificate.

---

#### Q15: Will HTTPS work after deleting credentials?

**Answer**: It depends on your setup. Possible outcomes:

**Scenario 1: Downgrade to HTTP**
- HTTPS is disabled; WebUI falls back to HTTP (port 80).
- Security decreases as data travels over plaintext.

**Scenario 2: Self-signed certificate**
- The system creates a temporary self-signed certificate.
- Browsers show â€œCertificate not trusted.â€
- Manual trust is required to proceed.

**Scenario 3: Service stops**
- If mTLS is mandatory, HTTPS connections will be refused until you reinstall credentials.

**Advice**:
- Plan ahead before deleting credentials.
- Testing environments can delete without impact.
- Production systems should install a replacement certificate before removing the old one.

---
#### Q13: â€œCertificate and private key do not matchâ€?

**Symptom**: After pasting the certificate, the error shows â€œCertificate and private key do not match.â€

**Cause**:
- The certificate was not signed with the current device key pair.
- Possible reasons:
  - The CSR came from another device.
  - The key pair was regenerated after the CSR was created.
  - The CA used the wrong CSR.

**Fix**:

**Option 1: Regenerate the CSR**
1. Click **â€œğŸ“‹ Generate CSRâ€** again on the device.
2. Copy the new CSR.
3. Submit it to the CA.
4. Install the newly signed certificate.

**Option 2: Delete credentials and restart**
1. Click **â€œğŸ—‘ï¸ Delete Credentials.â€**
2. Begin from Section 5.3.1 (generate key pair).
3. Follow the full flow to ensure CSR, signing, and installation all use the same key.

**Prevention**:
- âœ… Do not regenerate the key pair after creating a CSR.
- âœ… Confirm the CSR filename (e.g., `device-001.csr`) and certificate file correspond.
- âœ… Label files clearly to avoid confusion.

---
### 7.4 HTTPS Certificate Issues

#### Q12: â€œGenerate CSRâ€ button is greyed out?

**Symptom**: The **â€œğŸ“‹ Generate CSRâ€** button is disabled (greyed).

**Reason**: A key pair has not been generated. CSR signing requires a private key.

**Fix**:
1. Click **â€œğŸ”‘ Generate Key Pair.â€**
2. Wait for the key pair to finish.
3. The CSR button (and Install Certificate/Install CA buttons) will enable automatically.

**Related buttons**:
- â€œInstall Certificateâ€ and â€œInstall CAâ€ also depend on a generated key pair.
- Only â€œGenerate Key Pairâ€ and â€œDelete Credentialsâ€ are always active.

---
#### Q10: How to handle Host Fingerprint mismatch warnings?

**Symptom**: A red warning pops up: â€œâš ï¸ Security Warning: Host fingerprint mismatch.â€

**Correct handling** (see Section 4.4):

1. **ğŸ›‘ Stop immediately**: Do not click â€œUpdate Host Keyâ€ without confirmation.
2. **ğŸ“ Contact the administrator**: Ask if the server was rebuilt or the host key changed.
3. **âœ… If legitimate**: Click â€œUpdate Host Key,â€ then reconnect and trust the new fingerprint.
4. **âŒ If uncertain**: Click â€œCancelâ€ and investigate the network/security environment.

**Mistakes to avoid**:
- âŒ Clicking â€œUpdate Host Keyâ€ automatically (could signal an MITM attack).
- âŒ Ignoring the warning and forcing the connection.
- âŒ Assuming itâ€™s a bugâ€”this is a critical security feature.

**Security reminder**:
- ğŸ”´ A fingerprint mismatch is a serious warning.
- ğŸ”´ Always verify before trusting.
- ğŸ”´ Frequent warnings may indicate an insecure network.

---

#### Q11: How to verify host fingerprints?

**Scenario**: You need to confirm a serverâ€™s fingerprint (first-time connection or mismatch).

**Method 1: Get the fingerprint from the server**:
1. Log into the server through console or a trusted channel.
2. Run:
   ```bash
   # ECDSA
   ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub

   # ED25519
   ssh-keygen -lf /etc/ssh/ssh_host_ed25519_key.pub

   # RSA
   ssh-keygen -lf /etc/ssh/ssh_host_rsa_key.pub
   ```
3. Output example:
   ```
   256 SHA256:xYzAbC123456789aBcDeF/gHiJkLmNoPqRsTuVwXyZ01= root@server (ECDSA)
   ```
4. Compare the `SHA256:...` string with the one displayed.
   - They must match exactly (character-by-character).

**Method 2: Ask the administrator for the official fingerprint.**
**Method 3: Use another trusted device**:
1. From a verified device, SSH into the server.
2. Record the fingerprint shown there.
3. Compare it to the TianshanOS warning.

**Security tip**:
- High-security environments (finance, healthcare) should verify fingerprints before connecting.
- Internal test environments may take a more relaxed approach.

---
### 7.3 Known Host Fingerprint Issues

#### Q9: The Known Host Fingerprints list is empty?

**Symptom**: The list reads â€œNo known hostsâ€ even after you connected to SSH servers.

**Possible Causes**:

**Cause 1: You truly havenâ€™t connected yet**
|- Solution: Connect once (deploy or use the key). After trusting the host, the list will populate.

**Cause 2: Initialization bug (known issue)**
|- Behavior: Youâ€™ve connected and trusted hosts, yet the list stays empty until you refresh the page.
|- Reason: The `ts_known_hosts` module uses delayed initialization and may not start during the security service startup.
|- Fix: Trigger an SSH connection to initialize, then refresh the security page.

**Cause 3: NVS data corruption**
|- Symptom: The CLI `hosts --list` command also shows nothing.
|- Fix: Reconnect to each host and trust them again to rebuild the records.

**To verify records** (requires root terminal access):
```bash
# View hosts
hosts --list

# View JSON details
hosts --list --json
```

---
#### Q8: The Deployed Hosts list is empty?

**Symptom**: You deployed a key, yet the table still shows â€œNo deployed hosts.â€

**Cause**: Only hosts deployed via the WebUI appear in the list.

**Not recorded scenarios**:
- âŒ Deployments via CLI (`ssh --copyid`).
- âŒ Manually appending the public key to `authorized_keys`.
- âŒ Keys deployed on other devices or via different tools.

**Resolution**:
- If you want WebUI management, redeploy the key through the UI.
- Alternatively, use CLI commands like `hosts --deployed` to view/manage hosts.

**Design note**:
- Records are stored locally in `ts_ssh_hosts_config`.
- Only WebUI or specific API deployments are tracked to provide a unified management interface.

---
#### Q7: Deployment succeeded but password is still requested?

**Symptom**: The deployment dialog shows success, yet passwordless SSH still prompts for a password.

**Possible Causes**:
1. `authorized_keys` permissions are incorrect.
2. SSH configuration does not permit public key authentication.
3. Home directory or `.ssh` directory permissions are too permissive.
4. SELinux context issues (on RHEL/CentOS).

**Fix**:

1. **Check permissions** on the server:
   ```bash
   ls -ld ~/.ssh
   ls -l ~/.ssh/authorized_keys

   # Correct permissions:
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
2. **Inspect file contents**:
   ```bash
   cat ~/.ssh/authorized_keys
   ```
   Ensure it contains a line starting with `ssh-rsa` or `ecdsa-sha2-`.
3. **Verify SSH configuration**:
   ```bash
   sudo cat /etc/ssh/sshd_config | grep -E "PubkeyAuthentication|AuthorizedKeysFile"

   # Confirm:
   PubkeyAuthentication yes
   AuthorizedKeysFile .ssh/authorized_keys
   ```
4. **Check SELinux** (if applicable):
   ```bash
   restorecon -R ~/.ssh
   ```
5. **Restart SSH** if configuration changed:
   ```bash
   sudo systemctl restart sshd
   ```

---
#### Q6: â€œAuthentication failedâ€ during deployment?

**Symptom**: After entering the password, the UI shows â€œAuthentication failedâ€ or â€œWrong password.â€

**Possible Causes**:
1. Password typos (case, special characters).
2. Incorrect username.
3. SSH server disallows password authentication.
4. Account is locked.

**Fix**:

1. **Recheck the password**:
   - SSH passwords are case sensitive.
   - Watch for spaces or quotes.
   - Test the password on another system.
2. **Confirm the username**:
   - Verify the correct account name.
   - Some systems disable password login for `root`.
3. **Review SSH configuration**:
   ```bash
   sudo cat /etc/ssh/sshd_config | grep PasswordAuthentication

   # Ensure the line reads:
   PasswordAuthentication yes

   # Restart SSH to apply changes:
   sudo systemctl restart sshd
   ```
4. **Check account status**:
   ```bash
   sudo passwd -S <username>
   ```

---
### 7.2 Deployment & Connection Issues

#### Q5: â€œConnection timeoutâ€ during deployment?

**Symptom**: The deployment process hangs and returns â€œConnection timeout.â€

**Possible Reasons**:
1. Network is unreachable (device cannot reach the target host).
2. SSH service is down on the host.
3. Firewalls block port 22 (or a custom port).
4. IP address or port is misentered.

**Troubleshooting**:

**Step 1: Check connectivity**
- If you have terminal access, run `ping <host>`.
- Alternatively, ping from another device.

**Step 2: Check SSH service**
- On the server: `systemctl status sshd` or `service ssh status`.
- Ensure SSH is active.

**Step 3: Inspect firewall rules**
- Outbound SSH must be allowed from the device.
- Inbound SSH (port 22 or custom) must be allowed on the server.
  ```bash
  sudo ufw status
  sudo firewall-cmd --list-all
  ```

**Step 4: Confirm parameters**
- Verify IP, port, and username.
- Try connecting from another machine to ensure the server is reachable.

---
#### Q2: ECDSA keys fail to connect via SSH?

**Symptom**: Deploying or using an ECDSA key fails with authentication errors like â€œAuthentication failedâ€ or â€œUnsupported key type.â€

**Cause**: The current TianshanOS SSH client does not support ECDSA public key authentication (known limitation).

**Fix**:
1. Delete the ECDSA key.
2. Generate a new key using **RSA 2048-bit** or **RSA 4096-bit**.
3. Redeploy the new key.

**Note**:
- ECDSA keys are still supported for HTTPS certificates.
- SSH ECDSA support will be added in a future release.

---

#### Q3: How to back up keys?

**Scenario**: You worry about device failure or firmware upgrades erasing keys.

**Method 1: Export the private key (requires prior permission)**:
1. Enable **â€œAllow Private Key Exportâ€** when generating the key.
2. After creation, click **â€œğŸ” Private Key.â€**
3. Download the `.pem` file.
4. Store it on encrypted offline media (USB drive, password manager).

**Method 2: Document the key metadata**:
1. Record the key ID, type, and notes.
2. List which servers it is deployed to.
3. If lost, regenerate and redeploy the key.

**Recommendation**:
- Production keys: enable export and secure backup.
- Test keys: skip backup and regenerate if needed.

---

#### Q4: Can a deleted key be restored?

**Answer**: âŒ **No.**

**Details**:
- Deletion removes the key from NVS permanently.
- There is no recycle bin or undo feature.
- The only recovery method is to import a previously exported private key.

**Pre-deletion Checklist**:
1. âœ… Confirm the key is not on critical servers.
2. âœ… Revoke or remove deployments.
3. âœ… Export the private key if a backup is needed.
4. âœ… Notify teammates who rely on the key.

**If mistakenly deleted**:
- With a backup: use `key --import` through the CLI to restore.
- Without a backup: regenerate and redeploy a new key.

---
## Reference Documents

The following docs provide additional technical depth and troubleshooting guidance. They will be accessible through Mintlify once published.

### Deep Technical Details

- **â€œSecurity Implementationâ€**:
  - Defines security levels (L1-L4).
  - Explains key storage (NVS encryption, capacity).
  - Details SSH authentication methods (password, public key, secure storage).
  - Covers WebUI authentication (user roles, permissions, session handling).

- **â€œPKI Designâ€**:
  - Describes the mTLS architecture.
  - Explains the CA hierarchy (Root CA, Intermediate CA).
  - Details certificate types and policies.
  - Outlines device activation steps.
  - Documents certificate update mechanisms.

### Command-Line Operations

- **â€œCommand Referenceâ€**:
  - `key`: All CLI key management commands.
  - `ssh`: Full parameter set for SSH connections, deployments, and revocations.
  - `hosts`: CLI management for known hosts and deployed hosts.
  - `cert` (if available): CLI certificate operations.

### Troubleshooting

- **â€œTroubleshootingâ€**:
  - SSH connection debugging.
  - Solutions when the known host list stays empty.
  - Certificate validation failure steps.
  - Network diagnostics.

### Quick Start

- **â€œQuick Startâ€**:
  - Overview of TianshanOS.
  - WebUI navigation guidance.
  - A brief introduction to the Security page.
  - First-time configuration steps.

---
### 8.4 Certificate Management Best Practices

#### 1. Renew in advance

**Renewal timeline**:
- ğŸ“… **>30 days left**: Routine check; no action required.
- ğŸ“… **30-15 days left**: Prepare renewal and contact the CA.
- ğŸ“… **15-7 days left**: Execute the renewal process.
- ğŸ“… **<7 days**: Treat as high priority.

**Reminder suggestions**:
- Set calendar alerts 30 days before expiration.
- Use monitoring systems to watch certificate status.

#### 2. Back up the CA chain

**Why backup**:
- The CA chain is common across devices tuned to the same PKI.
- Backups let you repurpose the chain without re-downloading it.
- You can still validate device certificates if the CA server is unreachable.

**How to backup**:
1. Click â€œView Certificateâ€ to copy the device certificate.
2. Save the CA chain as `ca-chain.pem`.
3. Store them in a secure document system or configuration repository.

**Usage**:
- Apply to new devices quickly.
- Serve as a fallback if the CA server is offline.

#### 3. Test renewal workflows in a lab

**For multi-device deployments**:
1. Execute the full certificate process on a test device first.
2. Verify the certificate works and mTLS connections succeed.
3. Once validated, roll out to production devices.

**Checklist**:
- [ ] Certificate installed successfully?
- [ ] HTTPS service starts without errors?
- [ ] mTLS works both ways?
- [ ] Clients can still connect?

#### 4. Regularly inspect certificate health

**Inspection frequency**:
- ğŸ—“ï¸ Monthly: Check the status card.
- ğŸ—“ï¸ Quarterly: Review certificate details for anomalies.
- ğŸ—“ï¸ After major changes: Revalidate certificate integrity.

**Inspection items**:
- [ ] Status is â€œActivated.â€
- [ ] Validity exceeds 30 days.
- [ ] The CN is correct.
- [ ] The issuer is the expected CA.

---
### 8.3 Host Fingerprint Management Best Practices

#### 1. Verify during the first connection

**Standard workflow (high security)**:
1. Obtain the official fingerprint from the administrator.
2. Compare it with the one shown when connecting.
3. Once confirmed, type `yes` to trust.
4. Document when and who verified the fingerprint.

**Simplified workflow (internal testing)**:
1. Confirm the IP address is correct.
2. Type `yes` to trust.
3. Rely on automatic verification afterward.

#### 2. Responding to mismatches

**Golden rule**: **Always treat fingerprint mismatches seriously.**

**Priority order**:
1. ğŸ”´ Verify whether the server was rebuilt or keys changed.
2. ğŸŸ¡ Investigate the network environment (untrusted Wi-Fi, proxies).
3. ğŸŸ¢ Update the host key only after confirming legitimacy.

**Record changes**:
- Log who updated the fingerprint, why, and when.
- Retain evidence of server reinstallation or key rotation.

#### 3. Regular cleanup

**Targets**:
- Retired servers.
- Reused IP addresses.
- Temporary testing hosts.

**Actions**:
- Quarterly review of Known Host Fingerprints.
- Delete entries no longer in use.
- Keep the list tidy for easier management.

---
### 8.2 Deployment Management Best Practices

#### 1. Document deployments

**Use a spreadsheet or documentation table**:

| Key ID | Deployed Host | Username | Purpose | Deployment Date | Owner |
|--------|---------------|----------|---------|-----------------|-------|
| agx_prod | 192.168.1.100 | nvidia | AGX monitoring | 2026-01-30 | Alice |
| lpmu_test | 10.10.99.50 | root | LPMU testing | 2026-01-28 | Bob |

**Benefits**:
- Simplifies maintenance and auditing.
- Helps during personnel transitions.
- Speeds up incident response.

#### 2. Test immediately after deployment

**Workflow**:
1. After deployment, click **â€œğŸ” Test.â€**
2. Ensure the connection succeeds.
3. If it fails, fix issues immediately.

**Test items**:
- Connection success
- Correct username
- Command execution works

#### 3. Revoke access you no longer need

When:
- ğŸš« Projects finish.
- ğŸ”„ Employees leave.
- ğŸ”’ Servers are retired or moved.

**Action**:
1. Click â€œRevokeâ€ from the Deployed Hosts list.
2. Or remove the entry from the serverâ€™s `authorized_keys`.

#### 4. Maintain a key rotation plan

**Strategy**:
- ğŸ”„ Rotate critical server keys annually.
- ğŸ”„ Rotate regular server keys every 2â€“3 years or as required.
- ğŸ”„ Rotate test keys after the project ends.

**Rotation steps**:
1. Generate the new key (`agx_2027`).
2. Deploy it to servers.
3. Test connectivity.
4. Revoke the old key.
5. Delete the old key.

---
## Conclusion

This document covers every feature and workflow on the TianshanOS Security page. As an **admin user**, you now know how to manage SSH keys, remote host connections, and HTTPS certificates.

**Recommendations**:
1. ğŸ“– Read this guide fully before using the security page for the first time.
2. ğŸ§ª Practice the workflows in a test environment first.
3. ğŸ”– Bookmark this page for quick reference.
4. ğŸ“š Dive into the referenced technical docs for advanced topics.

**Safety reminders**:
- ğŸ” Keep keys and certificates protected.
- ğŸš¨ Treat all security warnings (e.g., fingerprint mismatches) seriously.
- ğŸ”„ Regularly review and rotate keys/certificates.
- ğŸ“‹ Log important changes and operations.

If you have questions or suggestions, contact your system administrator or consult the project documentation library.
