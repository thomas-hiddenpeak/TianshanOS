<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TianshanOS</title>
    <!-- 关键 CSS 内联：首屏渲染所需最小样式（header/nav/loading/layout） -->
    <style>
    :root{--bg-page:#f9fafb;--bg-card:#ffffff;--bg-muted:#f3f4f6;--text-primary:#111827;--text-secondary:#6b7280;--text-muted:#9ca3af;--border:#e5e7eb;--border-hover:#d1d5db;--blue-50:rgba(59,130,246,.06);--blue-500:#3b82f6;--blue-600:#2563eb;--rose-50:rgba(244,63,94,.06);--rose-500:#f43f5e;--emerald-50:rgba(16,185,129,.06);--emerald-500:#10b981;--radius-sm:0.375rem;--radius:0.5rem;--radius-lg:0.75rem;--radius-full:9999px;--shadow-sm:0 1px 2px 0 rgb(0 0 0/.05);--shadow:0 1px 3px 0 rgb(0 0 0/.1),0 1px 2px -1px rgb(0 0 0/.1);--shadow-lg:0 10px 15px -3px rgb(0 0 0/.1),0 4px 6px -4px rgb(0 0 0/.1);--ease:cubic-bezier(.4,0,.2,1);--t-fast:.15s var(--ease);--t-normal:.2s var(--ease);--header-height:60px;--footer-height:50px}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-page);color:var(--text-primary);line-height:1.5;-webkit-font-smoothing:antialiased;font-size:14px}
    #app{min-height:100vh;display:flex;flex-direction:column}
    .header{height:var(--header-height);background:var(--bg-card);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;position:fixed;top:0;left:0;right:0;z-index:100;box-shadow:var(--shadow-sm)}
    .logo{display:flex;align-items:center;gap:8px;font-size:1.5rem;font-weight:bold}
    .logo-icon{width:32px;height:32px;object-fit:contain;display:block}
    .nav{display:flex;gap:20px;margin-left:0}
    .nav-link{color:var(--text-secondary);text-decoration:none;padding:8px 12px;border-radius:var(--radius);transition:all var(--t-fast);font-size:.875rem;font-weight:500}
    .nav-link:hover,.nav-link.active{color:var(--blue-500);background:var(--blue-50)}
    .user-menu{margin-left:auto;display:flex;align-items:center;gap:12px}
    .main{flex:1;margin-top:var(--header-height);padding:20px}
    .footer{height:var(--footer-height);line-height:var(--footer-height);text-align:center;color:var(--text-muted);font-size:.8rem}
    .footer p{margin:0;display:inline;line-height:inherit}
    .hidden{display:none !important}
    .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;gap:20px}
    .loading .loading-icon{font-size:48px;color:var(--blue-500);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:7px 14px;font-size:.8rem;font-weight:500;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);cursor:pointer;transition:all var(--t-fast);white-space:nowrap;font-family:inherit;line-height:1.4;box-shadow:var(--shadow-sm)}
    .btn-service-style{background:var(--blue-50)!important;color:var(--blue-600)!important;border-radius:var(--radius-sm);padding:4px 12px;border:1px solid transparent}
    .btn-sm{padding:6px 12px;font-size:.85rem}
    .ws-status{width:10px;height:10px;border-radius:50%;background:var(--rose-500);flex-shrink:0;transition:background .3s;box-shadow:0 0 0 3px var(--rose-50)}
    .ws-status.connected{background:var(--emerald-500);box-shadow:0 0 0 3px var(--emerald-50)}
    .header-separator{width:1px;height:24px;background-color:var(--border);margin:0 16px}
    .lang-switch{margin-left:16px;position:relative}
    .lang-btn{display:flex;align-items:center;gap:4px;padding:4px 10px;font-size:.8rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all var(--t-fast);font-family:inherit;box-shadow:var(--shadow-sm)}
    .lang-btn.btn-service-style{background:transparent!important;color:var(--blue-500)!important;border:none!important;box-shadow:none!important}
    .lang-arrow{font-size:.65rem;margin-left:2px;opacity:.7}
    .lang-menu{position:absolute;top:100%;right:0;margin-top:4px;min-width:160px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);z-index:1000;overflow:hidden}
    .lang-menu.hidden{display:none}
    .modal{display:flex;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.4);align-items:center;justify-content:center}
    .modal.hidden{display:none!important}
    .modal-content{background:var(--bg-card);border-radius:var(--radius-lg);max-width:600px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
    </style>
    <!-- 主 CSS 异步加载（非阻塞渲染） -->
    <link rel="preload" href="/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
    <link rel="stylesheet" href="/fonts/remixicon.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/tslogo-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/images/tslogo-48.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/tslogo-256.png">
    <!-- xterm.js: 延迟加载，仅在终端页面使用时按需加载 -->
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="logo">
                <img src="/images/tslogo-48.png" alt="TianshanOS Logo" class="logo-icon">
                <span class="logo-text">TianshanOS</span>
            </div>
            <div class="lang-switch" id="lang-switch" title="切换语言 / Switch Language">
                <button class="btn btn-sm lang-btn btn-service-style" onclick="toggleLanguageMenu()">
                    <span id="lang-name">中文</span>
                    <span class="lang-arrow">▼</span>
                </button>
                <div id="lang-menu" class="lang-menu hidden">
                    <!-- 动态填充语言列表 -->
                </div>
            </div>
            <div class="header-separator"></div>
            <nav class="nav">
                <a href="#/" class="nav-link active" data-i18n="nav.system">系统</a>
                <a href="#/network" class="nav-link" data-i18n="nav.network">网络</a>
                <a href="#/files" class="nav-link" data-i18n="nav.files">文件</a>
                <a href="#/terminal" class="nav-link" data-requires-root data-i18n="common.logs">日志</a>
                <a href="#/automation" class="nav-link" data-requires-root data-i18n="nav.automation">自动化</a>
                <a href="#/commands" class="nav-link" data-requires-root data-i18n="ssh.commands">指令</a>
                <a href="#/security" class="nav-link" data-i18n="nav.security">安全</a>
            </nav>
            <div class="user-menu">
                <div class="ws-status" id="ws-status" data-i18n-title="network.connected"></div>
                <span id="user-name" data-i18n="ui.notLoggedIn">未登录</span>
                <button id="login-btn" class="btn btn-service-style" data-i18n="security.login">登录</button>
            </div>
        </header>
        
        <main class="main">
            <div id="page-content">
                <!-- 动态页面内容由 SPA 路由器加载 -->
                <div class="loading">
                    <i class="ri-refresh-line loading-icon"></i>
                    <p data-i18n="common.loading">Loading</p>
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <p>&copy; 2026 TianshanOS ｜ RMinte® AI Technology Co., Ltd. ｜ www.RMinte.com</p>
        </footer>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-header">
                <h2><i class="ri-door-open-line"></i> <span data-i18n="login.welcome">登录 TianshanOS</span></h2>
            </div>
            <form id="login-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="username" data-i18n="login.username">用户名</label>
                        <input type="text" id="username" name="username" class="input" required 
                               value="admin" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="password" data-i18n="login.password">密码</label>
                        <input type="password" id="password" name="password" class="input" required 
                               data-i18n-placeholder="login.passwordPlaceholder" placeholder="请输入密码" autocomplete="current-password">
                    </div>
                    <div id="login-error" class="form-error hidden"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeLoginModal()" data-i18n="common.cancel">取消</button>
                    <button type="submit" class="btn btn-service-style" data-i18n="login.loginButton">登录</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- LED 控制模态框 -->
    <div id="led-modal" class="modal hidden">
        <div class="modal-content led-modal">
            <div class="modal-header">
                <h2 id="led-modal-title" data-i18n="led.title">LED 设置</h2>
                <div id="led-modal-header-actions"></div>
                <button class="modal-close" onclick="closeLedModal()"><i class="ri-close-line"></i></button>
            </div>
            <div id="led-modal-body" class="modal-body">
                <!-- 动态内容 -->
            </div>
        </div>
    </div>
    
    <!-- 文件选择器模态框 -->
    <div id="file-picker-modal" class="modal hidden">
        <div class="modal-content file-picker-modal">
            <div class="modal-header">
                <h2><i class="ri-folder-open-line"></i> <span data-i18n="files.selectFiles">选择文件</span></h2>
                <button class="modal-close" onclick="closeFilePicker()">&times;</button>
            </div>
            <div class="file-picker-path">
                <button class="btn btn-sm" onclick="filePickerGoUp()"><i class="ri-arrow-up-s-line"></i> <span data-i18n="files.parentFolder">上级</span></button>
                <span id="file-picker-current-path">/sdcard/images</span>
            </div>
            <div class="file-picker-list" id="file-picker-list">
                <div class="loading" data-i18n="common.loading">Loading...</div>
            </div>
            <div class="file-picker-selected">
                <span data-i18n="files.fileName">已选择</span>: <span id="file-picker-selected-name">-</span>
            </div>
            <div class="form-actions">
                <button class="btn" onclick="closeFilePicker()" data-i18n="common.cancel">取消</button>
                <button class="btn btn-service-style" id="file-picker-confirm" onclick="confirmFilePicker()" disabled data-i18n="common.confirm">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 内存详情模态框 - 复刻全局色彩校正，关闭按钮右上角 -->
    <div id="memory-detail-modal" class="modal hidden">
        <div class="modal-content memory-detail-modal cc-compact">
            <div class="modal-header">
                <h2><span data-i18n="system.memoryDetail">内存详细分析</span></h2>
                <button class="modal-close" onclick="hideMemoryDetailModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body" id="memory-detail-body">
                <div class="loading" data-i18n="common.loading">Loading...</div>
            </div>
            <div class="modal-footer" style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
                <span id="memory-detail-timestamp" style="font-size:0.8em;color:#9ca3af">-</span>
                <button class="btn btn-service-style" onclick="refreshMemoryDetail()"><i class="ri-refresh-line"></i> <span data-i18n="common.refresh">刷新</span></button>
            </div>
        </div>
    </div>
    
    <!-- 数据源变量模态框 -->
    <div id="source-variables-modal" class="modal hidden">
        <div class="modal-content cc-compact" style="max-width:700px">
            <div class="modal-header">
                <h2><i class="ri-bar-chart-box-line"></i> <span data-i18n="automation.viewVariables">数据源变量</span></h2>
                <button class="modal-close" onclick="closeSourceVariablesModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body" id="source-variables-body">
                <div class="loading" data-i18n="common.loading">Loading...</div>
            </div>
            <div class="modal-footer cc-compact-footer">
                <button class="btn" onclick="closeSourceVariablesModal()" style="color:#6b7280" data-i18n="common.close">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 关机设置模态框 - 复刻全局色彩校正风格，无 emoji -->
    <div id="shutdown-settings-modal" class="modal hidden">
        <div class="modal-content cc-compact" style="max-width:500px">
            <div class="modal-header">
                <h2><span data-i18n="system.shutdownSettings">电压保护设置</span></h2>
                <button class="modal-close" onclick="closeShutdownSettingsModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body" id="shutdown-settings-body">
                <div class="cc-section">
                    <div class="form-group">
                        <label data-i18n="system.lowVoltageThreshold">低电压阈值 (V)</label>
                        <input type="number" id="ss-low-voltage" class="input" step="0.1" min="10" max="24" placeholder="12.6">
                        <small class="form-hint" data-i18n="system.lowVoltageThresholdHint">电压低于此值开始关机倒计时（默认 12.6V）</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="system.recoveryVoltageThreshold">恢复电压阈值 (V)</label>
                        <input type="number" id="ss-recovery-voltage" class="input" step="0.1" min="10" max="30" placeholder="18.0">
                        <small class="form-hint" data-i18n="system.recoveryVoltageThresholdHint">电压高于此值开始恢复流程（默认 18.0V）</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="system.shutdownDelay">关机倒计时 (秒)</label>
                        <input type="number" id="ss-shutdown-delay" class="input" step="1" min="10" max="600" placeholder="60">
                        <small class="form-hint" data-i18n="system.shutdownDelayHint">低电压后等待多久执行关机（默认 60秒）</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="system.recoveryHold">恢复稳定等待 (秒)</label>
                        <input type="number" id="ss-recovery-hold" class="input" step="1" min="1" max="300" placeholder="5">
                        <small class="form-hint" data-i18n="system.recoveryHoldHint">电压恢复后等待确认稳定（默认 5秒）</small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="system.fanStopDelay">风扇关闭延迟 (秒)</label>
                        <input type="number" id="ss-fan-stop-delay" class="input" step="1" min="10" max="600" placeholder="60">
                        <small class="form-hint" data-i18n="system.fanStopDelayHint">关机后多久关闭风扇（默认 60秒）</small>
                    </div>
                    <div id="shutdown-settings-error" class="form-error hidden"></div>
                </div>
                <div class="config-actions cc-actions">
                    <button class="btn btn-sm" onclick="resetShutdownSettings()" data-i18n="common.reset" style="color:#6b7280">恢复默认</button>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-sm" onclick="closeShutdownSettingsModal()" data-i18n="common.cancel" style="color:#6b7280">取消</button>
                        <button class="btn btn-service-style btn-sm" onclick="saveShutdownSettings()" data-i18n="common.save">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- i18n 国际化（内联避免 ERR_CONNECTION_RESET 导致 i18n 未定义） -->
    <script>
    (function(){
    var i18n = (function() {
        var currentLang = 'zh-CN';
        var languages = {};
        var supportedLanguages = { 'zh-CN': { name: '简体中文', flag: '' }, 'en-US': { name: 'English', flag: '' } };
        function registerLanguage(code, translations) { languages[code] = translations; }
        function setLanguage(lang) {
            if (languages[lang]) {
                currentLang = lang;
                try { localStorage.setItem('ts_language', lang); } catch(e) {}
                document.documentElement.lang = lang;
                window.dispatchEvent(new CustomEvent('languageChanged', { detail: { language: lang } }));
                return true;
            }
            return false;
        }
        function getLanguage() { return currentLang; }
        function translate(key, params) {
            params = params || {};
            var translations = languages[currentLang] || languages['zh-CN'] || {};
            var value = key.split('.').reduce(function(obj, k) { return obj && obj[k]; }, translations);
            if (value === undefined && currentLang !== 'en-US' && languages['en-US'])
                value = key.split('.').reduce(function(obj, k) { return obj && obj[k]; }, languages['en-US']);
            if (value === undefined) return key;
            if (typeof value === 'string' && Object.keys(params).length > 0)
                value = value.replace(/\{(\w+)\}/g, function(m, p) { return params[p] !== undefined ? params[p] : m; });
            return value;
        }
        function init() {
            try {
                var saved = localStorage.getItem('ts_language');
                if (saved && languages[saved]) currentLang = saved;
                else currentLang = (navigator.language || '').indexOf('zh') === 0 ? 'zh-CN' : 'en-US';
            } catch(e) {}
            document.documentElement.lang = currentLang;
        }
        function translateDOM(root) {
            root = root || document;
            root.querySelectorAll('[data-i18n]').forEach(function(el) {
                var key = el.getAttribute('data-i18n');
                var params = el.dataset.i18nParams ? JSON.parse(el.dataset.i18nParams) : {};
                el.textContent = translate(key, params);
            });
            root.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) { el.placeholder = translate(el.getAttribute('data-i18n-placeholder')); });
            root.querySelectorAll('[data-i18n-title]').forEach(function(el) { el.title = translate(el.getAttribute('data-i18n-title')); });
        }
        return { registerLanguage: registerLanguage, setLanguage: setLanguage, getLanguage: getLanguage, translate: translate, init: init, getSupportedLanguages: function() { return supportedLanguages; }, translateDOM: translateDOM };
    })();
    window.i18n = i18n;
    window.t = i18n.translate;
    window.setLanguage = i18n.setLanguage;
    window.getLanguage = i18n.getLanguage;
    window.translateDOM = i18n.translateDOM;
    window.toggleLanguageMenu = function() {
        var menu = document.getElementById('lang-menu');
        if (!menu) return;
        if (menu.classList.contains('hidden')) {
            var langs = i18n.getSupportedLanguages(), cur = i18n.getLanguage();
            menu.innerHTML = Object.keys(langs).map(function(code) {
                var info = langs[code];
                return '<div class="lang-menu-item' + (code === cur ? ' active' : '') + '" onclick="selectLanguage(\'' + code + '\')"><span class="lang-menu-name">' + info.name + '</span>' + (code === cur ? '<span class="lang-menu-check">✓</span>' : '') + '</div>';
            }).join('');
            menu.classList.remove('hidden');
            setTimeout(function() { document.addEventListener('click', window.closeLangMenuOnClickOutside); }, 10);
        } else menu.classList.add('hidden');
    };
    window.closeLangMenuOnClickOutside = function(e) {
        var sw = document.getElementById('lang-switch');
        if (sw && !sw.contains(e.target)) {
            var m = document.getElementById('lang-menu');
            if (m) m.classList.add('hidden');
            document.removeEventListener('click', window.closeLangMenuOnClickOutside);
        }
    };
    window.selectLanguage = function(lang) {
        /* 动态加载语言包后切换 */
        function doSwitch() {
            if (i18n.setLanguage(lang)) {
                var langs = i18n.getSupportedLanguages(), nameEl = document.getElementById('lang-name');
                if (nameEl && langs[lang]) nameEl.textContent = langs[lang].name.split(' ')[0];
                i18n.translateDOM();
                /* 通知 app.js 重新渲染当前页面 */
                if (typeof window.reloadCurrentPage === 'function') window.reloadCurrentPage();
                var m = document.getElementById('lang-menu');
                if (m) m.classList.add('hidden');
            }
        }
        /* 如果语言包尚未加载，先动态加载 */
        if (!window._loadedLangs || !window._loadedLangs[lang]) {
            var s = document.createElement('script');
            s.src = '/js/lang/' + lang + '.js';
            s.onload = function() {
                window._loadedLangs = window._loadedLangs || {};
                window._loadedLangs[lang] = true;
                doSwitch();
            };
            document.head.appendChild(s);
        } else {
            doSwitch();
        }
    };
    /* 动态加载当前语言包，初始化 i18n */
    (function loadInitialLang() {
        i18n.init();
        var cur = i18n.getLanguage();
        var nameEl = document.getElementById('lang-name');
        if (nameEl) nameEl.textContent = cur === 'zh-CN' ? '\u4e2d\u6587' : 'English';
        var s = document.createElement('script');
        s.src = '/js/lang/' + cur + '.js';
        s.onload = function() {
            window._loadedLangs = {};
            window._loadedLangs[cur] = true;
            var nameEl = document.getElementById('lang-name');
            if (nameEl) nameEl.textContent = cur === 'zh-CN' ? '中文' : 'EN';
            i18n.translateDOM();
        };
        document.head.appendChild(s);
    })();
    })();
    </script>
    
    <script defer src="/js/api.js"></script>
    <script defer src="/js/router.js"></script>
    <script defer src="/js/terminal.js"></script>
    <script defer src="/js/app.js"></script>
</body>
</html>
